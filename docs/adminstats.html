<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" href="./files/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    :root{
      font-family:'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
    }
    html, body{
      font-family:inherit;
      line-height:1.45;
      color:#111827;
      background:#F5F5F7;
    }
    button, input, textarea, select{
      font-family:inherit;
      line-height:1.2;
    }
    .sm-topbar{
      position:sticky;
      top:0;
      z-index:1000001;
      width:100%;
      box-sizing:border-box;
    }
    .sm-sheet-head{
      padding:14px 25px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:0px solid rgba(0,0,0,.08);
      background:#F5F5F7;
    }
    .sm-sheet-left{
      display:flex;
      align-items:center;
      gap:35px;
      flex:1;
      min-width:0;
    }
    .sm-sheet-brand{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      flex:0 0 auto;
    }
    .sm-sheet-brand img{
      max-width:100px;
      height:auto;
      display:block;
    }
  </style>
  <title></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- OpenReplay Tracking Code -->
<script>
  // ===== 1) Obtener idc desde la URL =====
  function smGetIDCFromURL() {
    var search = window.location.search || "";
    if (!search) return "";
    try {
      // Navegadores modernos
      var params = new URLSearchParams(search);
      return params.get("idc") || "";
    } catch (e) {
      // Fallback simple por si acaso
      var m = search.match(/[?&]idc=([^&]+)/i);
      return m ? decodeURIComponent(m[1].replace(/\+/g, " ")) : "";
    }
  }

  // Guardamos el idc para usarlo como userID
  var smIDC = smGetIDCFromURL();
  window.__smIDC = smIDC; // por si lo quieres usar en otras partes de tu app

  // ===== 2) Configuración OpenReplay =====
  var initOpts = {
    projectKey: "QonwVB9oKHTLvpz3EkMc",
    // 0 - plain, 1 - obscured, 2 - ignored
    defaultInputMode: 0,
    obscureTextNumbers: false,
    obscureTextEmails: false
  };

  // Aquí conectamos el idc al userID
  var startOpts = { userID: smIDC || "" };

  (function(A,s,a,y,e,r){
    r = window.OpenReplay = [e, r, y, [s - 1, e]];
    s = document.createElement('script');
    s.src = A;
    s.async = !a;
    document.getElementsByTagName('head')[0].appendChild(s);

    r.start = function(v){ r.push([0]); };
    r.stop = function(v){ r.push([1]); };
    r.setUserID = function(id){ r.push([2, id]); };
    r.setUserAnonymousID = function(id){ r.push([3, id]); };
    r.setMetadata = function(k, v){ r.push([4, k, v]); };
    r.event = function(k, p, i){ r.push([5, k, p, i]); };
    r.issue = function(k, p){ r.push([6, k, p]); };
    r.isActive = function(){ return false; };
    r.getSessionToken = function(){};
  })("//static.openreplay.com/latest/openreplay-assist.js", 1, 0, initOpts, startOpts);

  // (Opcional) Si quieres forzar el setUserID explícito cuando exista idc:
  (function(){
    if (!smIDC) return;
    try {
      if (window.OpenReplay && typeof OpenReplay.setUserID === "function") {
        OpenReplay.setUserID(smIDC);
      }
    } catch (e) {}
  })();
</script>
</head>
<body>
<div class="sm-topbar">
  <div class="sm-sheet-head">
    <div class="sm-sheet-left">
      <div class="sm-sheet-brand" aria-hidden="true">
        <img src="./files/logon.png" alt="Simple Marcas">
      </div>
    </div>
  </div>
</div>
<div id="sm-puntos-app" class="ga">
  <div class="ga-wrap">
    <!-- Top bar -->
    <div class="ga-top">
      <div class="ga-title-wrap">
        <div class="ga-title">Admin · Consultores</div>
        <div class="ga-subtitle" id="gaRangeLabel"></div>
      </div>
      <div class="ga-controls">
        <!-- GA-like range picker -->
        <div class="ga-range">
          <button type="button" id="gaRangeBtn" class="ga-range-btn" aria-haspopup="dialog" aria-expanded="false">
            <span class="ga-range-name" id="gaRangeName">Hoy</span>
            <span class="ga-range-sep">·</span>
            <span class="ga-range-dates" id="gaRangeDates"></span>
            <span class="ga-range-caret" aria-hidden="true"></span>
          </button>
          <div class="ga-range-pop" id="gaRangePop" style="display:none;">
            <div class="ga-range-inner">
              <div class="ga-range-body">
                <div class="ga-range-left" role="listbox" aria-label="Rangos">
                  <button type="button" class="ga-range-item ga-range-item-active" data-range="today">Hoy</button>
                  <button type="button" class="ga-range-item" data-range="yesterday">Ayer</button>
                  <button type="button" class="ga-range-item" data-range="7d">Últimos 7 días</button>
                  <button type="button" class="ga-range-item" data-range="28d">Últimos 28 días</button>
                  <button type="button" class="ga-range-item" data-range="month">Este mes</button>
                  <button type="button" class="ga-range-item" data-range="prevmonth">Mes anterior</button>
                  <button type="button" class="ga-range-item" data-range="custom">Personalizado</button>
                </div>
                <div class="ga-range-right">
                  <div class="ga-cal-head">
                    <div class="ga-cal-selected" id="gaCalSelected">Selecciona un rango</div>
                  </div>
                  <div class="ga-cal-scroll" id="gaCalScroll" aria-label="Calendario"></div>
                </div>
              </div>
              <div class="ga-range-foot">
                <button type="button" class="ga-range-action ga-range-cancel" id="gaRangeCancel">Cancelar</button>
                <button type="button" class="ga-range-action ga-range-apply" id="gaRangeApply">Aplicar</button>
              </div>
            </div>
          </div>
          <!-- se mantienen para tu lógica actual (hidden) -->
          <input type="hidden" id="smrStart">
          <input type="hidden" id="smrEnd">
        </div>
        <div class="ga-chip-group" id="gaMetricToggle" role="group" aria-label="Métrica">
          <button type="button" class="ga-chip ga-chip-active" data-metric="puntos">Puntos</button>
          <button type="button" class="ga-chip" data-metric="pesos" id="gaMetricPesos">Pesos</button>
        </div>
        <div class="ga-cons-filter">
          <button type="button" class="ga-range-btn ga-cons-btn" id="gaConsBtn" aria-haspopup="dialog" aria-expanded="false">
            <span class="ga-cons-label">Consultores</span>
            <span class="ga-cons-summary" id="gaConsBtnSummary">Todos</span>
            <span class="ga-range-caret" aria-hidden="true"></span>
          </button>
          <div class="ga-cons-pop" id="gaConsPop" style="display:none;">
            <div class="ga-cons-inner">
              <div class="ga-cons-head">
                <div class="ga-cons-title">Consultores</div>
                <div class="ga-cons-actions">
                  <button type="button" class="ga-cons-link" id="gaConsAll">Todos</button>
                  <button type="button" class="ga-cons-link" id="gaConsClear">Limpiar</button>
                </div>
              </div>
              <div class="ga-cons-search">
                <input type="search" id="gaConsSearch" placeholder="Buscar por nombre o ID">
              </div>
              <div class="ga-cons-list" id="gaConsList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- KPI cards -->
    <div class="ga-grid">
      <!-- PUNTOS -->
      <div class="ga-card ga-kpi">
        <div class="ga-kpi-title">Puntos</div>
        <div class="ga-kpi-value" id="smrTotal" style="display:none;">0</div>
        <div class="ga-skeleton" id="smrTotalLoading"></div>
        <div class="ga-kpi-meta" id="smrMeta"></div>
      </div>
      <!-- PESOS (solo con codep=917830109) -->
      <div class="ga-card ga-kpi ga-pesos-only" id="gaPesosCard">
        <div class="ga-kpi-title">Pesos</div>
        <div class="ga-kpi-value" id="gaPesos" style="display:none;">$ 0</div>
        <div class="ga-skeleton" id="gaPesosLoading"></div>
        <div class="ga-kpi-meta" id="gaRowsCount"></div>
      </div>
    </div>
    <!-- Chart -->
    <div class="ga-card ga-chart" style="margin-top: 14px;">
      <div class="ga-card-head">
        <div>
          <div class="ga-card-title" id="gaChartTitle">Puntos en el tiempo</div>
          <div class="ga-card-note" id="gaChartNote">Suma diaria (según rango)</div>
        </div>
        <div class="ga-chip-group ga-chip-group-compact" aria-label="Periodicidad">
          <button type="button" class="ga-chip" data-period="daily">Diario</button>
          <button type="button" class="ga-chip ga-chip-active" data-period="weekly">Semanal (L-D)</button>
        </div>
      </div>
      <div class="ga-chart-canvas">
        <canvas id="smrChart"></canvas>
      </div>
    </div>
    <div class="ga-card ga-summary" id="gaSummaryCard">
      <div class="ga-card-head">
        <div class="ga-card-title">Resumen por consultor</div>
        <div class="ga-card-note" id="gaSummaryNote">Totales del rango seleccionado</div>
      </div>
      <div class="ga-cons-listing" id="gaConsSummary"></div>
    </div>
    <div class="ga-card ga-table" id="gaRedFlagsCard">
      <div class="ga-card-head">
        <div class="ga-card-title">Red Flags</div>
        <div class="ga-card-note">Datos atípicos para revisión manual</div>
      </div>
      <div class="ga-skeleton" id="gaRedFlagsLoading"></div>
      <div class="ga-table-wrap" style="display:none;" id="gaRedFlagsWrap">
        <table class="ga-t">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Consultor</th>
              <th>ID</th>
              <th>Recorrido</th>
              <th>Tiempo</th>
              <th class="ga-right ga-col-puntos">Puntos</th>
              <th class="ga-right ga-col-pesos">Pesos</th>
              <th>Motivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="gaRedFlagsBody"></tbody>
        </table>
      </div>
    </div>
    <!-- Table -->
    <div class="ga-card ga-table">
      <div class="ga-card-head">
        <div class="ga-card-title">Histórico</div>
        <div class="ga-card-note">Últimas filas dentro del rango</div>
      </div>
      <div class="ga-skeleton" id="smrListLoading"></div>
      <div class="ga-table-wrap" style="display:none;" id="smrTableWrap">
        <table class="ga-t">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Consultor</th>
              <th>ID</th>
              <th>Recorrido</th>
              <th>Tiempo</th>
              <th class="ga-right ga-col-puntos">Puntos</th>
              <th class="ga-right ga-col-pesos">Pesos</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="smrTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<style>
  /* Base */
  #sm-puntos-app.ga{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#1f2937}
  .ga-wrap{max-width:1180px;margin:0 auto;padding:18px;box-sizing:border-box}
  .ga-card{
    background:#fff;border:1px solid rgba(17,24,39,.10);
    border-radius:14px; box-shadow:0 1px 0 rgba(17,24,39,.04);
  }
  /* Top */
  .ga-top{
    display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;
    margin-bottom:14px;
  }
  .ga-title{font-size:18px;font-weight:800;letter-spacing:-.01em}
  .ga-subtitle{font-size:12px;color:#6b7280;margin-top:4px}
  .ga-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .ga-chip-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .ga-chip-group-compact .ga-chip{padding:7px 10px;font-size:12px}
  .ga-chip{
    border:1px solid rgba(17,24,39,.12);
    background:#fff;
    color:#111827;
    border-radius:999px;
    padding:9px 12px;
    font-size:13px;
    cursor:pointer;
  }
  .ga-chip:hover{background:#f8fafc}
  .ga-chip-active{
    background:#111827;
    color:#fff;
    border-color:#111827;
  }
  .ga-cons-filter{position:relative}
  .ga-cons-btn{min-width:190px;justify-content:space-between}
  .ga-cons-btn .ga-cons-label{font-weight:800}
  .ga-cons-btn .ga-cons-summary{color:#6b7280;font-weight:600}
  .ga-cons-pop{
    position:absolute;
    top:calc(100% + 8px);
    right:0;
    z-index:999999;
    width:340px;
    max-width:calc(100vw - 24px);
    background:#fff;
    border:1px solid rgba(17,24,39,.12);
    border-radius:14px;
    box-shadow:0 14px 38px rgba(17,24,39,.12);
    overflow:hidden;
  }
  .ga-cons-inner{display:flex;flex-direction:column;max-height:420px}
  .ga-cons-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(17,24,39,.08)}
  .ga-cons-title{font-weight:800;font-size:13px}
  .ga-cons-actions{display:flex;gap:10px}
  .ga-cons-link{border:0;background:transparent;color:#2563eb;font-weight:700;font-size:12px;cursor:pointer;padding:0}
  .ga-cons-search{padding:10px 12px;border-bottom:1px solid rgba(17,24,39,.08)}
  .ga-cons-search input{
    width:100%;
    border:1px solid rgba(17,24,39,.12);
    border-radius:10px;
    padding:8px 10px;
    font-size:13px;
    outline:none;
  }
  .ga-cons-list{max-height:320px;overflow:auto;padding:4px 0}
  .ga-cons-item{
    display:flex;align-items:center;gap:10px;
    padding:8px 12px;
    cursor:pointer;
  }
  .ga-cons-item:hover{background:#f9fafb}
  .ga-cons-item input{accent-color:#111827}
  .ga-cons-dot{width:12px;height:12px;border-radius:999px;flex:0 0 auto}
  .ga-cons-name{font-weight:700;font-size:13px}
  .ga-cons-id{font-size:12px;color:#6b7280}
  .ga-cons-empty{padding:12px;font-size:13px;color:#6b7280}
  /* KPI grid */
  .ga-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
  @media(min-width:920px){ .ga-grid{grid-template-columns:1fr 1fr} }
  .ga-kpi{padding:14px 14px 12px}
  .ga-kpi-title{font-size:12px;color:#6b7280;font-weight:700;text-transform:uppercase;letter-spacing:.08em}
  .ga-kpi-value{font-size:40px;line-height:1.05;font-weight:800;margin-top:6px;letter-spacing:-.02em}
  .ga-kpi-meta{font-size:12px;color:#6b7280;margin-top:8px}
  /* Skeleton */
  .ga-skeleton{
    margin-top:10px;border-radius:10px;padding:10px 12px;
    background:linear-gradient(90deg,#f3f4f6,#fafafa,#f3f4f6);
    background-size:200% 100%;
    animation:gaShimmer 1.2s infinite linear;
    display:none;
  }
  @keyframes gaShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  #smrTotalLoading{ min-height: 48px; }
  #gaPesosLoading{ min-height: 48px; }
  #smrListLoading{ min-height: 56px; }
  /* Chart */
  .ga-chart{padding:0;overflow:hidden}
  .ga-card-head{display:flex;align-items:baseline;justify-content:space-between;gap:10px;padding:14px 14px 8px}
  .ga-card-title{font-size:14px;font-weight:800}
  .ga-card-note{font-size:12px;color:#6b7280}
  .ga-chart-canvas{padding:0 10px 12px}
  .ga-chart-canvas canvas{width:100% !important;height:320px !important}
  .ga-summary{margin-top:12px}
  .ga-cons-listing{padding:4px 12px 14px;display:flex;flex-direction:column;gap:8px}
  .ga-cons-row{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:10px;border:1px solid rgba(17,24,39,.06);border-radius:12px;
  }
  .ga-cons-row-main{display:flex;align-items:center;gap:10px;min-width:0}
  .ga-cons-row-meta{display:flex;flex-direction:column;gap:2px;min-width:0}
  .ga-cons-row-meta .ga-cons-name{
    font-size:14px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .ga-cons-row-meta .ga-cons-id{font-size:12px;color:#6b7280}
  .ga-cons-value{font-weight:800;font-size:16px;text-align:right;white-space:nowrap}
  .ga-cons-subvalue{font-size:12px;color:#6b7280;text-align:right}
  .ga-dot{width:12px;height:12px;border-radius:999px;flex:0 0 auto}
  /* Table */
  .ga-table{margin-top:12px}
  .ga-table-wrap{overflow:auto;padding:6px 10px 12px;position:relative;z-index:0}
  .ga-t{width:100%;border-collapse:separate;border-spacing:0}
  .ga-t thead th{
    position:sticky;top:0;background:#fff;
    text-align:left;font-size:12px;color:#6b7280;font-weight:800;
    padding:10px 10px;border-bottom:1px solid rgba(17,24,39,.10);
    white-space:nowrap;
  }
  .ga-t tbody td{
    font-size:13px;padding:10px 10px;border-bottom:1px solid rgba(17,24,39,.06);
    white-space:nowrap;vertical-align:top;
  }
  .ga-t tbody tr:hover{background:#fafafa}
  .ga-right{text-align:right}
  .ga-row-rejected td{ text-decoration:line-through; color:#9ca3af; }
  .ga-flag-actions{display:flex;gap:8px;flex-wrap:wrap}
  .ga-btn-flag{
    border:0;
    background:#fff;
    border-radius:999px;
    padding:6px;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:32px;
  }
  .ga-btn-flag-accept{color:#15803d;border:1px solid rgba(21,128,61,.12);background:rgba(21,128,61,.08);}
  .ga-btn-flag-reject{color:#b91c1c;border:1px solid rgba(185,28,28,.12);background:rgba(185,28,28,.08);}
  .ga-btn-flag-edit{color:#0f172a;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.06);}
  .ga-tip{
    position:relative;
    display:inline-block;
    vertical-align:top;
  }
  .ga-tip-text{
    display:inline-block;
    max-width:260px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ga-tip:hover::after{
    content: attr(data-tip);
    position:absolute;
    left:0;
    top:calc(100% + 6px);
    background:#fff;
    color:#000;
    border:1px solid rgba(0,0,0,.12);
    box-shadow:0 12px 28px rgba(0,0,0,.18);
    border-radius:8px;
    padding:8px 10px;
    white-space:normal;
    max-width:320px;
    z-index:20000;
  }
  /* Recorrido */
  .ga-rec{
    white-space:nowrap;
    max-width:220px;
    overflow:hidden;
    text-overflow:ellipsis;
    display:inline-block;
    vertical-align:top;
  }
  /* ===================== PESOS: solo con codep ===================== */
  #sm-puntos-app.ga .ga-pesos-only{ display:none; }
  #sm-puntos-app.ga .ga-col-pesos{ display:none; }
  #sm-puntos-app.ga.ga-show-pesos .ga-pesos-only{ display:block; }
  #sm-puntos-app.ga.ga-show-pesos .ga-col-pesos{ display:table-cell; }
  #sm-puntos-app.ga.ga-no-pesos .ga-grid{ grid-template-columns:1fr !important; }
  /* Métrica seleccionada */
  #sm-puntos-app.ga.ga-metric-puntos .ga-col-pesos{ display:none !important; }
  #sm-puntos-app.ga.ga-metric-pesos .ga-col-puntos{ display:none !important; }
  /* ===================== GA RANGE (UNIFICADO / SIN DUPLICADOS) ===================== */
  .ga-range{position:relative;display:flex;align-items:center}
  .ga-range-btn{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid rgba(17,24,39,.12);
    background:#fff;color:#111827;
    border-radius:12px;
    padding:10px 12px;
    cursor:pointer;
    font-size:13px;
    line-height:1;
    user-select:none;
  }
  .ga-range-btn:hover{background:#fafafa}
  .ga-range-name{font-weight:800}
  .ga-range-sep{color:#9ca3af}
  .ga-range-dates{color:#6b7280}
  .ga-range-caret{
    width:0;height:0;margin-left:2px;
    border-left:5px solid transparent;
    border-right:5px solid transparent;
    border-top:6px solid rgba(17,24,39,.55);
  }
  .ga-range-pop{
    position:absolute;
    top:calc(100% + 8px);
    right:0;
    z-index:999999;
    width: 500px;
    max-width: calc(100vw - 24px);
    background:#fff;
    border:1px solid rgba(17,24,39,.12);
    border-radius:14px;
    box-shadow:0 14px 38px rgba(17,24,39,.12);
    overflow:hidden;
  }
  .ga-range-inner{
  display:flex;
  flex-direction:column;
  min-height:320px;
}
.ga-range-body{
  display:grid;
  grid-template-columns:220px 1fr;
  flex:1 1 auto;
  min-height:0; /* clave para que el scroll del calendario funcione */
}
.ga-range-foot{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  padding:12px;
  border-top:1px solid rgba(17,24,39,.08);
  background:#fff;
}
  @media(max-width:860px){
    .ga-range-pop{right:auto;left:0}
    .ga-range-body{grid-template-columns:1fr}
    .ga-range-left{border-right:0;border-bottom:1px solid rgba(17,24,39,.08)}
  }
  .ga-range-left{
    padding:10px;
    background:#fbfbfc;
    border-right:1px solid rgba(17,24,39,.08);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .ga-range-item{
    text-align:left;
    border:1px solid transparent;
    background:transparent;
    border-radius:10px;
    padding:10px 10px;
    cursor:pointer;
    font-size:13px;
    color:#111827;
  }
  .ga-range-item:hover{background:#f3f4f6}
  .ga-range-item-active{
    background:#edf2ff;
    border-color:rgba(54,116,232,.25);
  }
  .ga-range-right{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0; /* clave */
}
  .ga-cal-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .ga-cal-selected{font-size:13px;font-weight:800;color:#111827}
  .ga-range-action{
    border:1px solid rgba(17,24,39,.12);
    border-radius:10px;
    padding:10px 12px;
    font-size:13px;
    cursor:pointer;
    background:#fff;
  }
  .ga-range-apply{
    background:#111827;
    color:#fff;
    border-color:#111827;
  }
  .ga-range-apply:hover{filter:brightness(.98)}
  .ga-cal-scroll{
    max-height:360px;
    overflow:auto;
    padding-right:6px;
  }
  /* Mes */
  .ga-month{
    padding:10px 8px;
    border:1px solid rgba(17,24,39,.08);
    border-radius:12px;
    background:#fff;
    margin-bottom:10px
  }
  .ga-month-title{font-size:13px;font-weight:800;margin-bottom:8px}
  .ga-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
  .ga-dow div{font-size:11px;color:#6b7280;font-weight:800;text-align:center}
 /* Días */
.ga-days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  column-gap:0;
  row-gap:5px;
}
.ga-day{
  height:30px;
  border-radius:0;                 /* rango continuo */
  border:1px solid transparent;
  background:#fff;
  cursor:pointer;
  font-size:12px;
  line-height:1;
  color:#111827;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  isolation:isolate;   
  overflow:visible;
  z-index:0;
            /* CLAVE para z-index negativos */
}
/* Eleva el rango sobre los días vecinos para que no se "muerda" */
.ga-day.is-inrange{ z-index:1; }
.ga-day.is-start,
.ga-day.is-end{ z-index:2; }
.ga-day:hover{ background:#fafafa; }
.ga-day.is-empty{ visibility:hidden; pointer-events:none; }
.ga-day.is-disabled{ opacity:.35; pointer-events:none; }
/* Rango intermedio: usa background (cero cortes blancos) */
.ga-day.is-inrange{
  background:rgba(54,116,232,.12);
}
/* Start/End: texto blanco (el círculo va detrás) */
.ga-day.is-start,
.ga-day.is-end{
  color:#fff;
}
/* círculo perfecto DETRÁS del número (por eso se ve el número) */
.ga-day.is-start::after,
.ga-day.is-end::after{
  content:"";
  position:absolute;
  width:32px;
  height:32px;
  border-radius:999px;
  background:#3674E8;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  z-index:-1;                      /* CLAVE: atrás del texto */
  pointer-events:none;
}
/* barra que conecta start/end con el rango (también atrás) */
.ga-day.is-start::before,
.ga-day.is-end::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  z-index:-2;
  pointer-events:none;
}
/* bleeds para eliminar líneas blancas por subpixel */
.ga-day.is-start::before{
  left:50%;
  right:-2px;
}
.ga-day.is-end::before{
  left:-2px;
  right:50%;
}
/* si es un solo día: sin barra */
.ga-day.is-start.is-end::before{
  display:none;
}
</style>

    <script>
(function(){
  const ENDPOINT_LOG_MENSUAL = "https://script.google.com/macros/s/AKfycbwu1EIBD8PPVTCKIe39zO_sjMzUIAnjGqQxehzdEG2sXppjJEJnta8ZTegTv19T7W2y/exec";
  const TZ = "America/Santiago";
  const LOGIN_URL = "./index.html";
  function decodeTokenPayload(token){
    try{
      const parts = String(token || "").split(".");
      if (!parts[0]) return null;
      const json = atob(parts[0].replace(/-/g,"+").replace(/_/g,"/"));
      return JSON.parse(json);
    }catch(_){
      return null;
    }
  }
  function getToken(){
    const k = "sm_token";
    const params = new URLSearchParams(location.search);
    const urlT = (params.get("t") || "").trim();
    if (urlT){
      try{ sessionStorage.setItem(k, urlT); }catch(_){}
      return urlT;
    }
    try{
      const st = sessionStorage.getItem(k);
      if (st) return st.trim();
    }catch(_){}
    return "";
  }
  function authFetch(url, opts){
    return fetch(url, opts);
  }
  function ensureAuth(){
    const params = new URLSearchParams(location.search);
    const token = getToken();
    const idc = (params.get("idc") || params.get("IDC") || "").trim();
    const codep = (params.get("codep") || "").trim();
    const payload = decodeTokenPayload(token);
    if (!token || !codep || !payload){
      try{ sessionStorage.removeItem("sm_token"); }catch(_){}
      window.location.href = LOGIN_URL;
      return null;
    }
    const tokIdc = String(payload.idc || "").trim();
    const tokCodep = String(payload.codep || "").trim();
    if (tokIdc && idc && tokIdc !== idc){
      try{ sessionStorage.removeItem("sm_token"); }catch(_){}
      window.location.href = LOGIN_URL;
      return null;
    }
    if (tokCodep && codep && tokCodep !== codep){
      try{ sessionStorage.removeItem("sm_token"); }catch(_){}
      window.location.href = LOGIN_URL;
      return null;
    }
    return { token, idc, codep };
  }

  function whenReady(fn){
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", fn, { once:true });
    } else {
      fn();
    }
  }

  whenReady(()=>{
    let tries = 0;
    const t = setInterval(()=>{
      tries++;
      const root = document.getElementById("sm-puntos-app");
      if (!root){
        if (tries >= 60) clearInterval(t);
        return;
      }
      clearInterval(t);
      boot(root);
    }, 150);
  });

  function boot(root){
    const auth = ensureAuth();
    if (!auth) return;
    const qs  = (s)=> root.querySelector(s);
    const qsa = (s)=> Array.from(root.querySelectorAll(s));

    // limpiar subtítulo
    const rangeLbl = qs("#gaRangeLabel");
    if (rangeLbl) rangeLbl.textContent = "";

    // ========= PESOS: SIEMPRE DISPONIBLE EN ADMIN =========
    const showPesos = true;
    root.classList.add("ga-show-pesos");

    function getIDCFilter(){ return auth.idc; }

    function sameIDC(rowIDC, urlIDC){
      const a = String(rowIDC ?? "").trim();
      const b = String(urlIDC ?? "").trim();
      if (/^\d+$/.test(a) && /^\d+$/.test(b)) return Number(a) === Number(b);
      return a === b;
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    // ---- TZ offset helper (para timestamps correctos en Chile) ----
    const _dtfOffset = new Intl.DateTimeFormat("en-US", {
      timeZone: TZ,
      hourCycle: "h23",
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });

    function tzOffsetMs(utcTs){
      const parts = _dtfOffset.formatToParts(new Date(utcTs));
      const get = (t)=> parts.find(p=>p.type===t)?.value;
      const y = Number(get("year"));
      const m = Number(get("month"));
      const d = Number(get("day"));
      const hh = Number(get("hour"));
      const mi = Number(get("minute"));
      const ss = Number(get("second"));
      const asUTC = Date.UTC(y, m-1, d, hh, mi, ss);
      return asUTC - utcTs;
    }

    function tzMidnightTsFromYMD(ymd){
      const m = String(ymd||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return NaN;
      const y = Number(m[1]), mo = Number(m[2]), da = Number(m[3]);
      const baseUtc = Date.UTC(y, mo-1, da, 0,0,0);
      return baseUtc - tzOffsetMs(baseUtc);
    }

    function tzEndOfDayTsFromYMD(ymd){
      const start = tzMidnightTsFromYMD(ymd);
      if (!isFinite(start)) return NaN;
      return start + 24*60*60*1000 - 1;
    }

    function setLoading(on){
      const t  = qs("#smrTotal");
      const tl = qs("#smrTotalLoading");
      const p  = qs("#gaPesos");
      const pl = qs("#gaPesosLoading");
      const lw = qs("#smrListLoading");
      const tw = qs("#smrTableWrap");
      const rfl = qs("#gaRedFlagsLoading");
      const rfw = qs("#gaRedFlagsWrap");

      if (t)  t.style.display  = on ? "none" : "block";
      if (tl) tl.style.display = on ? "block" : "none";
      if (p)  p.style.display  = on ? "none" : "block";
      if (pl) pl.style.display = on ? "block" : "none";
      if (lw) lw.style.display = on ? "block" : "none";
      if (tw) tw.style.display = on ? "none" : "block";
      if (rfl) rfl.style.display = on ? "block" : "none";
      if (rfw) rfw.style.display = on ? "none" : "block";
    }

    function esc(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
    function fmtReason(reason){
      const full = String(reason || "").trim();
      if (!full) return "";
      const max = 20;
      const short = full.length > max ? (full.slice(0, max) + "...") : full;
      return `<span class="ga-tip" data-tip="${esc(full)}"><span class="ga-tip-text">${esc(short)}</span></span>`;
    }

    // ======== TIEMPO (duración) ========
    function fmtTimeHHMM(v){
      if (v === null || v === undefined) return "";

      if (typeof v === "string"){
        const s = v.trim();
        const m = s.match(/^(\d{1,3}):(\d{2})(?::(\d{2}))?$/);
        if (m) return `${Number(m[1])}:${pad2(m[2])}`;

        const mi = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
        if (mi){
          const y = Number(mi[1]);
          let totalMin = Number(mi[4]) * 60 + Number(mi[5]); // UTC
          if (y <= 1901) totalMin = (totalMin - 282 + 1440) % 1440; // corrige 04:42
          const hh = Math.floor(totalMin / 60);
          const mm = totalMin % 60;
          return `${hh}:${pad2(mm)}`;
        }
      }

      const n = Number(v);
      if (!isNaN(n) && isFinite(n) && n >= 0 && n < 1){
        const totalMin = Math.round(n * 24 * 60);
        const h = Math.floor(totalMin / 60);
        const m = totalMin % 60;
        return `${h}:${pad2(m)}`;
      }

      const d = new Date(String(v).trim());
      if (!isNaN(d.getTime())){
        const y = d.getUTCFullYear();
        let totalMin = d.getUTCHours() * 60 + d.getUTCMinutes();
        if (y <= 1901) totalMin = (totalMin - 282 + 1440) % 1440;
        const hh = Math.floor(totalMin / 60);
        const mm = totalMin % 60;
        return `${hh}:${pad2(mm)}`;
      }

      return String(v).trim();
    }
    function toSeconds(row){
      const sec = Number(row?.["TIEMPO TOTAL EN LLAMADA SEC"] || row?.TIEMPO_TOTAL_EN_LLAMADA_SEC || 0);
      if (isFinite(sec) && sec >= 0) return sec;
      const raw = String(row?.["TIEMPO TOTAL EN LLAMADA"] || "").trim();
      const m = raw.match(/^(\d{1,3}):(\d{2})(?::(\d{2}))?$/);
      if (m){
        const h = Number(m[1]) || 0;
        const mi = Number(m[2]) || 0;
        const s = Number(m[3] || 0) || 0;
        return h*3600 + mi*60 + s;
      }
      return 0;
    }
    function normText(s){
      return String(s || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
    }
    function hasAny(txt, arr){
      const t = normText(txt);
      return arr.some(x => t.includes(normText(x)));
    }
    function isRejected(row){
      return String(row?.FLAG_STATUS || "").toLowerCase() === "rejected";
    }
    function isAdjusted(row){
      return String(row?.FLAG_STATUS || "").toLowerCase() === "adjusted";
    }
    function markDupFlags(rows){
      const lastByCons = new Map(); // key -> last IDPIPE seen (orden actual)
      for (const r of rows){
        const info = normalizeConsultor(r);
        const id = String(r.IDPIPE || "").trim();
        const prev = lastByCons.get(info.key);
        r.__dupFlag = false;
        if (id && prev && prev === id){
          r.__dupFlag = true;
        }
        if (id) lastByCons.set(info.key, id);
      }
    }
    function isAdjusted(row){
      return String(row?.FLAG_STATUS || "").toLowerCase() === "adjusted";
    }
    function isRedFlag(row){
      // Ya gestionados (aceptados/rechazados/ajustados) no se muestran en la lista
      const st = String(row?.FLAG_STATUS || "").toLowerCase();
      if (st === "accepted" || st === "rejected" || st === "adjusted") return false;

      const rec = normText(row?.RECORRIDO || "");
      const sec = toSeconds(row);

      const cond1 = hasAny(rec, ["numero equivocado","telefono invalido","no contesto"]) && sec > 180; // >3 min
      const cond2 = hasAny(rec, ["se envia ficha","se envía ficha"]) && sec < 300; // <5 min
      const cond3 = !rec.includes("telefono invalido") && sec <= 1; // 0:00 sin Telefono Invalido

      return cond1 || cond2 || cond3 || !!row.__dupFlag;
    }
    function buildRedFlagReason(row){
      const rec = normText(row?.RECORRIDO || "");
      const sec = toSeconds(row);
      if (hasAny(rec, ["numero equivocado","telefono invalido","no contesto"]) && sec > 180){
        return "Número equivocado/No contesta > 3 min";
      }
      if (hasAny(rec, ["se envia ficha","se envía ficha"]) && sec < 300){
        return "Se envía ficha < 5 min";
      }
      if (!rec.includes("telefono invalido") && sec <= 1){
        return "Sin Teléfono Inválido y duración 0:00";
      }
      if (row.__dupFlag){
        return "ID repetido consecutivo (consultor)";
      }
      return "";
    }

    // ======== RANGE PICKER PRO (scroll meses) ========
    function ymdNowInTZ(){
      return new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date());
    }

    function ymdToUTCDate(ymd){
      const m = String(ymd||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const ts = tzMidnightTsFromYMD(`${m[1]}-${m[2]}-${m[3]}`);
      if (!isFinite(ts)) return null;
      return new Date(ts); // ancla al inicio del día en la TZ para evitar corrimientos
    }

    function utcDateToYMD(d){
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const da = String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function addDaysYMD(ymd, days){
      const d = ymdToUTCDate(ymd);
      if (!d) return "";
      d.setUTCDate(d.getUTCDate() + days);
      return utcDateToYMD(d);
    }

    function compareYMD(a,b){
      if (a === b) return 0;
      return a < b ? -1 : 1;
    }

    function fmtRangeTextFromYMD(sYMD, eYMD){
      const sD = ymdToUTCDate(sYMD);
      const eD = ymdToUTCDate(eYMD);
      if (!sD || !eD) return "";
      const clean = (x)=> String(x||"").replace(/\./g,"");
      const fmt = (d, withYear)=> clean(new Intl.DateTimeFormat("es-CL", withYear
        ? { day:"numeric", month:"short", year:"numeric", timeZone: TZ }
        : { day:"numeric", month:"short", timeZone: TZ }
      ).format(d));
      const sameYear = sD.getUTCFullYear() === eD.getUTCFullYear();
      return sameYear ? `${fmt(sD,false)} — ${fmt(eD,true)}` : `${fmt(sD,true)} — ${fmt(eD,true)}`;
    }

    function setActivePresetKey(key){
      qsa(".ga-range-item").forEach(b=>{
        b.classList.toggle("ga-range-item-active", b.getAttribute("data-range") === key);
      });
    }

    function monthTitleES(year, monthIndex0){
      const d = new Date(Date.UTC(year, monthIndex0, 1, 12,0,0));
      const txt = new Intl.DateTimeFormat("es-CL", { timeZone: TZ, month:"long", year:"numeric" }).format(d);
      return txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    function buildMonthGrid(year, monthIndex0){
      const first = new Date(Date.UTC(year, monthIndex0, 1, 0,0,0));
      const next = new Date(Date.UTC(year, monthIndex0+1, 1, 0,0,0));
      const daysInMonth = Math.round((next - first) / 86400000);

      // Monday=0..Sunday=6
      const dowSunday0 = first.getUTCDay(); // 0..6
      const dowMon0 = (dowSunday0 + 6) % 7;

      const wrap = document.createElement("div");
      wrap.className = "ga-month";
      wrap.setAttribute("data-month", `${year}-${String(monthIndex0+1).padStart(2,"0")}`);

      const title = document.createElement("div");
      title.className = "ga-month-title";
      title.textContent = monthTitleES(year, monthIndex0);
      wrap.appendChild(title);

      const dow = document.createElement("div");
      dow.className = "ga-dow";
      ["L","M","M","J","V","S","D"].forEach(x=>{
        const el = document.createElement("div");
        el.textContent = x;
        dow.appendChild(el);
      });
      wrap.appendChild(dow);

      const grid = document.createElement("div");
      grid.className = "ga-days";

      for (let i=0;i<dowMon0;i++){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "ga-day is-empty";
        b.textContent = "";
        grid.appendChild(b);
      }

      for (let d=1; d<=daysInMonth; d++){
        const ymd = `${year}-${String(monthIndex0+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const b = document.createElement("button");
        b.type = "button";
        b.className = "ga-day";
        b.setAttribute("data-ymd", ymd);
        b.textContent = String(d);
        grid.appendChild(b);
      }

      wrap.appendChild(grid);
      return wrap;
    }

    let applied = null; // {key,label,startYMD,endYMD}
    let pending = null;

    function syncTopButton(){
      const nameEl = qs("#gaRangeName");
      const datesEl = qs("#gaRangeDates");
      if (!nameEl || !datesEl || !applied) return;
      nameEl.textContent = applied.label;
      datesEl.textContent = fmtRangeTextFromYMD(applied.startYMD, applied.endYMD);
    }

    function setHiddenRangeFromApplied(){
      const startInp = qs("#smrStart");
      const endInp   = qs("#smrEnd");
      if (startInp) startInp.value = applied.startYMD;
      if (endInp)   endInp.value   = applied.endYMD;
    }

    function paintSelection(){
      const sel = qs("#gaCalSelected");
      if (sel){
        if (!pending || !pending.startYMD) sel.textContent = "Selecciona un rango";
        else if (pending.startYMD && !pending.endYMD) sel.textContent = `Inicio: ${fmtRangeTextFromYMD(pending.startYMD, pending.startYMD)}`;
        else sel.textContent = fmtRangeTextFromYMD(pending.startYMD, pending.endYMD);
      }

      qsa(".ga-day[data-ymd]").forEach(btn=>{
        const ymd = btn.getAttribute("data-ymd");
        btn.classList.remove("is-start","is-end","is-inrange");

        if (!pending || !pending.startYMD) return;

        const s = pending.startYMD;
        const e = pending.endYMD;

        if (ymd === s) btn.classList.add("is-start");
        if (e && ymd === e) btn.classList.add("is-end");

        if (e){
          const lo = compareYMD(s,e) <= 0 ? s : e;
          const hi = compareYMD(s,e) <= 0 ? e : s;
          if (ymd > lo && ymd < hi) btn.classList.add("is-inrange");
        }
      });
    }

    function openPop(){
      const pop = qs("#gaRangePop");
      const btn = qs("#gaRangeBtn");
      if (!pop || !btn) return;
      pop.style.display = "block";
      btn.setAttribute("aria-expanded","true");

      // copiar applied->pending
      pending = applied ? { ...applied } : null;
      setActivePresetKey(pending?.key || "custom");
      paintSelection();

      // scroll al mes actual
      const nowYMD = ymdNowInTZ();
      const month = nowYMD.slice(0,7);
      const monthEl = pop.querySelector(`.ga-month[data-month="${month}"]`);
      const sc = qs("#gaCalScroll");
      if (monthEl && sc){
        const top = monthEl.offsetTop - 8;
        sc.scrollTop = top > 0 ? top : 0;
      }
    }

    function closePop(revert){
      const pop = qs("#gaRangePop");
      const btn = qs("#gaRangeBtn");
      if (!pop || !btn) return;
      pop.style.display = "none";
      btn.setAttribute("aria-expanded","false");
      if (revert) pending = applied ? { ...applied } : null;
    }

    function applyPending(){
      if (!pending || !pending.startYMD) return;

      // si no hay end, end=start
      if (!pending.endYMD) pending.endYMD = pending.startYMD;

      // normaliza orden
      if (compareYMD(pending.endYMD, pending.startYMD) < 0){
        const tmp = pending.startYMD;
        pending.startYMD = pending.endYMD;
        pending.endYMD = tmp;
      }

      applied = { ...pending };

      // label
      if (!applied.key || applied.key === "custom"){
        applied.key = "custom";
        applied.label = "Personalizado";
      }

      setHiddenRangeFromApplied();
      syncTopButton();
      closePop(false);
      load();
    }

    function presetByKey(key){
      const today = ymdNowInTZ();
      if (key === "today"){
        return { key, label:"Hoy", startYMD: today, endYMD: today };
      }
      if (key === "yesterday"){
        const y = addDaysYMD(today, -1);
        return { key, label:"Ayer", startYMD: y, endYMD: y };
      }
      if (key === "7d"){
        return { key, label:"Últimos 7 días", startYMD: addDaysYMD(today, -6), endYMD: today };
      }
      if (key === "28d"){
        return { key, label:"Últimos 28 días", startYMD: addDaysYMD(today, -27), endYMD: today };
      }
      if (key === "month"){
        const d = ymdToUTCDate(today);
        const y = d.getUTCFullYear();
        const m0 = d.getUTCMonth();
        const first = `${y}-${String(m0+1).padStart(2,"0")}-01`;
        return { key, label:"Este mes", startYMD:first, endYMD: today };
      }
      if (key === "prevmonth"){
        const d = ymdToUTCDate(today);
        let y = d.getUTCFullYear();
        let m0 = d.getUTCMonth() - 1;
        if (m0 < 0){ m0 = 11; y -= 1; }
        const first = new Date(Date.UTC(y, m0, 1));
        const next = new Date(Date.UTC(y, m0+1, 1));
        next.setUTCDate(next.getUTCDate() - 1);
        const firstYMD = utcDateToYMD(first);
        const lastYMD = utcDateToYMD(next);
        return { key, label:"Mes anterior", startYMD:firstYMD, endYMD:lastYMD };
      }
      return null;
    }

    function initRangeUI(){
      const btn = qs("#gaRangeBtn");
      const pop = qs("#gaRangePop");
      const sc  = qs("#gaCalScroll");
      if (!btn || !pop || !sc) return;

      // Render meses: -12 a +2 (scrolleable)
      const now = ymdToUTCDate(ymdNowInTZ());
      const baseY = now.getUTCFullYear();
      const baseM = now.getUTCMonth();

      sc.innerHTML = "";
      for (let i=-12; i<=2; i++){
        const d = new Date(Date.UTC(baseY, baseM + i, 1));
        sc.appendChild(buildMonthGrid(d.getUTCFullYear(), d.getUTCMonth()));
      }

      // click afuera cierra
      document.addEventListener("click", ()=> closePop(true));
      pop.addEventListener("click", (ev)=> ev.stopPropagation());

      // toggle
      btn.addEventListener("click", (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        const open = pop.style.display === "block";
        if (open) closePop(true);
        else openPop();
      });

      // presets
      qsa(".ga-range-item").forEach(b=>{
        b.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();

          const key = b.getAttribute("data-range");
          if (!key) return;

          if (key === "custom"){
            if (pending){
              pending.key = "custom";
              pending.label = "Personalizado";
            }
            setActivePresetKey("custom");
            paintSelection();
            return;
          }

          const p = presetByKey(key);
          if (!p) return;

          pending = { ...p };
          setActivePresetKey(key);
          paintSelection();
        });
      });

      // click día en calendario
      sc.addEventListener("click", (ev)=>{
        const b = ev.target && ev.target.closest && ev.target.closest(".ga-day[data-ymd]");
        if (!b) return;
        const ymd = b.getAttribute("data-ymd");
        if (!ymd) return;

        if (!pending || !pending.startYMD || (pending.startYMD && pending.endYMD)){
          pending = pending || { key:"custom", label:"Personalizado" };
          pending.key = "custom";
          pending.label = "Personalizado";
          pending.startYMD = ymd;
          pending.endYMD = "";
          setActivePresetKey("custom");
          paintSelection();
          return;
        }

        // start existe y no hay end
        pending.key = "custom";
        pending.label = "Personalizado";
        pending.endYMD = ymd;
        setActivePresetKey("custom");
        paintSelection();
      });

      // acciones
      const cancelBtn = qs("#gaRangeCancel");
      const applyBtn  = qs("#gaRangeApply");

      if (cancelBtn){
        cancelBtn.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          closePop(true);
        });
      }

      if (applyBtn){
        applyBtn.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          applyPending();
        });
      }

      // init: últimos 28 días (más útil para ver datos al cargar)
      applied = presetByKey("28d");
      pending = { ...applied };
      setActivePresetKey("28d");
      setHiddenRangeFromApplied();
      syncTopButton();
      paintSelection();
    }

    // ======== CONSULTOR & MÉTRICAS ========
    const METRIC_PUNTOS = "puntos";
    const METRIC_PESOS = "pesos";
    const PERIOD_DAILY = "daily";
    const PERIOD_WEEKLY = "weekly";
    const palette = [
      "#2563EB", // azul
      "#D946EF", // fucsia
      "#16A34A", // verde
      "#F97316", // naranja
      "#DC2626", // rojo
      "#0EA5E9", // celeste
      "#7C3AED", // púrpura
      "#22C55E", // verde claro
      "#EAB308", // amarillo
      "#F43F5E", // rosado
      "#0891B2", // teal
      "#B45309", // café
      "#475569", // gris azulado
      "#10B981", // esmeralda
      "#EF4444"  // rojo vivo extra
    ];
    const dayFmt = new Intl.DateTimeFormat("sv-SE", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
    function weekStartFromYMD(ymd){
      const d = ymdToUTCDate(ymd);
      if (!d) return "";
      const dowMon0 = (d.getUTCDay() + 6) % 7; // 0 lunes .. 6 domingo
      d.setUTCDate(d.getUTCDate() - dowMon0);
      return utcDateToYMD(d);
    }
    function weekLabel(weekStartYMD){
      const start = weekStartYMD;
      const end = addDaysYMD(weekStartYMD, 6);
      return fmtRangeTextFromYMD(start, end);
    }

    let chart = null;
    const state = {
      rows: [],
      metric: METRIC_PUNTOS,
      period: PERIOD_WEEKLY,
      consultores: [],
      selectedKeys: new Set(),
      colorByKey: new Map()
    };

    function colorForKey(key){
      const k = String(key || "");
      if (state.colorByKey.has(k)) return state.colorByKey.get(k);
      const idx = state.colorByKey.size;
      let color = palette[idx % palette.length] || palette[0];
      if (idx >= palette.length){
        const angle = (idx - palette.length) * 137.508; // golden angle for spread
        const h = ((angle % 360) + 360) % 360;
        color = `hsl(${h}deg, 65%, 52%)`;
      }
      state.colorByKey.set(k, color);
      return color;
    }
    function assignColors(list){
      const newMap = new Map();
      let assigned = 0;
      for (const c of list){
        const key = String(c.key || "");
        if (!key) continue;
        const existing = state.colorByKey.get(key);
        if (existing){
          newMap.set(key, existing);
          continue;
        }
        let color = palette[assigned % palette.length] || palette[0];
        if (assigned >= palette.length){
          const angle = (assigned - palette.length) * 137.508;
          const h = ((angle % 360) + 360) % 360;
          color = `hsl(${h}deg, 65%, 52%)`;
        }
        newMap.set(key, color);
        assigned++;
      }
      state.colorByKey = newMap;
    }
    function rgba(hex, alpha){
      const m = String(hex || "").trim().match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if (!m) return hex;
      const r = parseInt(m[1],16);
      const g = parseInt(m[2],16);
      const b = parseInt(m[3],16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function normalizeConsultor(row){
      const rawIdc = String(row?.IDC ?? row?.idc ?? row?.CONSULTOR_ID ?? row?.consultor_id ?? "").trim();
      const rawName = String(row?.CONSULTOR ?? row?.consultor ?? row?.NOMBRE ?? row?.nombre ?? "").trim();
      const key = rawIdc || (rawName ? `name:${rawName.toLowerCase()}` : "desconocido");
      const display = rawName && rawIdc ? `${rawName} (${rawIdc})` : (rawName || rawIdc || "Sin consultor");
      return { key, idc: rawIdc, name: rawName, display };
    }
    function getMetricValue(row, metric){
      return Number((metric === METRIC_PESOS ? row?.PESOS : row?.PUNTOS) || 0);
    }
    function fmtMetricVal(val, metric){
      if (metric === METRIC_PESOS){
        return `$ ${Number(val || 0).toLocaleString("es-CL")}`;
      }
      return Number(val || 0).toLocaleString("es-CL");
    }
    function computeTotals(rows){
      let puntos = 0, pesos = 0;
      for (const r of rows){
        puntos += Number(r?.PUNTOS || 0);
        pesos  += Number(r?.PESOS  || 0);
      }
      return { puntos, pesos, count: rows.length };
    }
    function filterBySelection(rows){
      if (!state.selectedKeys.size) return [];
      if (state.selectedKeys.size === state.consultores.length) return rows;
      return rows.filter(r => state.selectedKeys.has(normalizeConsultor(r).key));
    }
    function syncMetricUI(){
      qsa("[data-metric]").forEach(btn=>{
        const m = btn.getAttribute("data-metric");
        btn.classList.toggle("ga-chip-active", m === state.metric);
      });
      root.classList.toggle("ga-metric-puntos", state.metric === METRIC_PUNTOS);
      root.classList.toggle("ga-metric-pesos", state.metric === METRIC_PESOS);
      const title = qs("#gaChartTitle");
      const note  = qs("#gaChartNote");
      if (title) title.textContent = state.metric === METRIC_PESOS ? "Pesos en el tiempo" : "Puntos en el tiempo";
      if (note)  note.textContent  = state.metric === METRIC_PESOS
        ? (state.period === PERIOD_WEEKLY ? "Suma semanal en pesos (lun-dom)" : "Suma diaria en pesos (según rango)")
        : (state.period === PERIOD_WEEKLY ? "Suma semanal (lun-dom)" : "Suma diaria (según rango)");
    }
    function syncPeriodUI(){
      qsa("[data-period]").forEach(btn=>{
        const p = btn.getAttribute("data-period");
        btn.classList.toggle("ga-chip-active", p === state.period);
      });
      syncMetricUI();
      renderAll();
    }
    function updateConsBtnSummary(){
      const el = qs("#gaConsBtnSummary");
      if (!el) return;
      const total = state.consultores.length;
      const sel = state.selectedKeys.size;
      if (!total){
        el.textContent = "Sin datos";
        return;
      }
      if (sel === 0){
        el.textContent = "Ninguno";
        return;
      }
      if (sel === total){
        el.textContent = "Todos";
        return;
      }
      if (sel === 1){
        const only = state.consultores.find(c => state.selectedKeys.has(c.key));
        el.textContent = only ? only.display : "1 seleccionado";
        return;
      }
      el.textContent = `${sel} seleccionados`;
    }

    function renderConsSelector(filterTerm){
      const list = qs("#gaConsList");
      if (!list) return;
      const term = (filterTerm || "").toLowerCase();
      list.innerHTML = "";
      const filtered = state.consultores.filter(c=>{
        if (!term) return true;
        return c.display.toLowerCase().includes(term) || String(c.idc || "").toLowerCase().includes(term);
      });
      if (!filtered.length){
        list.innerHTML = `<div class="ga-cons-empty">No hay consultores</div>`;
        return;
      }
      for (const c of filtered){
        const row = document.createElement("label");
        row.className = "ga-cons-item";
        row.innerHTML = `
          <input type="checkbox" data-key="${esc(c.key)}" ${state.selectedKeys.has(c.key) ? "checked" : ""}>
          <span class="ga-cons-dot" style="background:${colorForKey(c.key)}"></span>
          <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
            <span class="ga-cons-name">${esc(c.name || c.display || "Sin consultor")}</span>
            <span class="ga-cons-id">${esc(c.idc || "")}</span>
          </div>
        `;
        row.querySelector("input").addEventListener("change",(ev)=>{
          const key = c.key;
          const next = new Set(state.selectedKeys);
          if (ev.target.checked) next.add(key); else next.delete(key);
          state.selectedKeys = next;
          updateConsBtnSummary();
          renderConsSelector(qs("#gaConsSearch")?.value || "");
          renderAll();
        });
        list.appendChild(row);
      }
    }
    function openConsPop(){
      const pop = qs("#gaConsPop");
      const btn = qs("#gaConsBtn");
      if (!pop || !btn) return;
      pop.style.display = "block";
      btn.setAttribute("aria-expanded","true");
      const search = qs("#gaConsSearch");
      if (search){ search.value = ""; }
      renderConsSelector("");
    }
    function closeConsPop(){
      const pop = qs("#gaConsPop");
      const btn = qs("#gaConsBtn");
      if (!pop || !btn) return;
      pop.style.display = "none";
      btn.setAttribute("aria-expanded","false");
    }

    function buildSeriesByConsultor(rows){
      const labelsSet = new Set();
      const perCons = new Map(); // key -> { info, map(date->sum) }
      for (const r of rows){
        const info = normalizeConsultor(r);
        const ts = Number(r?.TS_MS || 0);
        const dateKey = ts ? dayFmt.format(new Date(ts)) : "";
        if (!dateKey) continue;
        const aggKey = state.period === PERIOD_WEEKLY ? weekStartFromYMD(dateKey) : dateKey;
        if (!aggKey) continue;
        labelsSet.add(aggKey);
        if (!perCons.has(info.key)){
          perCons.set(info.key, { info, map:new Map() });
        }
        const entry = perCons.get(info.key);
        entry.map.set(aggKey, (entry.map.get(aggKey) || 0) + getMetricValue(r, state.metric));
      }
      const labels = Array.from(labelsSet).sort();
      const datasets = Array.from(perCons.values()).map(({info,map})=>{
        const color = colorForKey(info.key);
        const data = labels.map(l => map.get(l) || 0);
        return {
          label: info.display,
          data,
          tension: 0,
          pointRadius: 3,
          borderColor: color,
          pointBorderColor: color,
          pointBackgroundColor: color,
          backgroundColor: rgba(color, 0.1)
        };
      });
      const displayLabels = labels.map(l => state.period === PERIOD_WEEKLY ? weekLabel(l) : l);
      return { labels: displayLabels, datasets };
    }

    function renderSummary(rows){
      const wrap = qs("#gaConsSummary");
      const note = qs("#gaSummaryNote");
      if (!wrap) return;
      wrap.innerHTML = "";
      const map = new Map();
      for (const r of rows){
        const info = normalizeConsultor(r);
        if (!map.has(info.key)){
          map.set(info.key, { info, puntos:0, pesos:0, count:0 });
        }
        const entry = map.get(info.key);
        entry.puntos += Number(r?.PUNTOS || 0);
        entry.pesos  += Number(r?.PESOS  || 0);
        entry.count  += 1;
      }
      const arr = Array.from(map.values());
      const metricToSort = state.metric;
      arr.sort((a,b)=>{
        const va = metricToSort === METRIC_PESOS ? a.pesos : a.puntos;
        const vb = metricToSort === METRIC_PESOS ? b.pesos : b.puntos;
        if (vb !== va) return vb - va; // descendente
        const na = (a.info.name || a.info.display || "").toLowerCase();
        const nb = (b.info.name || b.info.display || "").toLowerCase();
        return na.localeCompare(nb);
      });
      if (!arr.length){
        wrap.innerHTML = `<div class="ga-cons-empty" style="padding:12px;">Sin consultores seleccionados</div>`;
      } else {
        for (const item of arr){
          const color = colorForKey(item.info.key);
          const mainVal = metricToSort === METRIC_PESOS ? item.pesos : item.puntos;
          wrap.insertAdjacentHTML("beforeend", `
            <div class="ga-cons-row">
              <div class="ga-cons-row-main">
                <span class="ga-dot" style="background:${color}"></span>
                <div class="ga-cons-row-meta">
                  <span class="ga-cons-name">${esc(item.info.name || item.info.display || "Sin consultor")}</span>
                  <span class="ga-cons-id">${esc(item.info.idc || "")}</span>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:2px;text-align:right;">
                <span class="ga-cons-value">${fmtMetricVal(mainVal, state.metric)}</span>
              </div>
            </div>
          `);
        }
      }
      if (note){
        const totalSel = state.selectedKeys.size;
        note.textContent = totalSel ? `Consultores seleccionados: ${totalSel}` : "Sin consultores seleccionados";
      }
    }

    function renderChart(rows){
      const canvas = qs("#smrChart");
      if (!canvas || !window.Chart){
        return;
      }
      const { labels, datasets } = buildSeriesByConsultor(rows);
      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:true } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }

    function renderRedFlags(rows){
      const body = qs("#gaRedFlagsBody");
      const wrap = qs("#gaRedFlagsWrap");
      const skel = qs("#gaRedFlagsLoading");
      if (!body || !wrap || !skel) return;

      const flags = rows.filter(r => isRedFlag(r));
      body.innerHTML = "";
      if (!flags.length){
        body.innerHTML = `<tr><td colspan="8" style="padding:12px;color:#6b7280;">Sin red flags pendientes.</td></tr>`;
      } else {
        for (const r of flags){
          const info = normalizeConsultor(r);
          const ts = Number(r?.TS_MS || 0);
          const d = ts ? new Date(ts).toLocaleString("es-CL") : (r["FECHA COMPLETA"] || "");
          const fullRec = String(r.RECORRIDO ?? "");
          const cutRec = fullRec.length > 80 ? fullRec.slice(0,80) + "..." : fullRec;
          const key = r.__key || `${r.__sheet || ""}#${r.__row || ""}`;
          const puntosVal = fmtMetricVal(r.PUNTOS || 0, METRIC_PUNTOS);
          const pesosVal = fmtMetricVal(r.PESOS || 0, METRIC_PESOS);
          const reason = isRedFlag(r) ? buildRedFlagReason(r) : "";
          body.insertAdjacentHTML("beforeend", `
            <tr data-key="${esc(key)}">
              <td>${esc(d)}</td>
              <td>${esc(info.display)}</td>
              <td>${esc(String(r.IDPIPE ?? ""))}</td>
              <td><span class="ga-rec" title="${esc(fullRec)}">${esc(cutRec)}</span></td>
              <td>${esc(fmtTimeHHMM(r["TIEMPO TOTAL EN LLAMADA"]))}</td>
              <td class="ga-right ga-col-puntos">${puntosVal}</td>
              <td class="ga-right ga-col-pesos">${pesosVal}</td>
              <td>${reason ? fmtReason(reason) : ""}</td>
              <td>
                <div class="ga-flag-actions">
                  <button type="button" class="ga-btn-flag ga-btn-flag-accept" data-flag="accept" aria-label="Aceptar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                  </button>
                  <button type="button" class="ga-btn-flag ga-btn-flag-reject" data-flag="reject" aria-label="Rechazar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban"><path d="M4.929 4.929 19.07 19.071"/><circle cx="12" cy="12" r="10"/></svg>
                  </button>
                </div>
              </td>
            </tr>
          `);
        }
      }
      skel.style.display = "none";
      wrap.style.display = "block";
    }

    function renderTable(rows){
      const tbody = qs("#smrTbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      for (const r of rows){
        const info = normalizeConsultor(r);
        const ts = Number(r?.TS_MS || 0);
        const d = ts ? new Date(ts).toLocaleString("es-CL") : (r["FECHA COMPLETA"] || "");
        const rejected = isRejected(r);
        const pesosCell = showPesos
          ? `<td class="ga-right ga-col-pesos">${fmtMetricVal(r.PESOS || 0, METRIC_PESOS)}</td>`
          : ``;
        const fullRec = String(r.RECORRIDO ?? "");
        const cutRec = fullRec.length > 80 ? fullRec.slice(0,80) + "..." : fullRec;
        const hasObs = !!String(r.FLAG_REASON || "").trim();
        const rowHtml = `
          <tr class="${rejected ? "ga-row-rejected" : ""}">
            <td>${esc(d)}</td>
            <td>${esc(info.display)}</td>
            <td>${esc(String(r.IDPIPE ?? ""))}</td>
            <td><span class="ga-rec" title="${esc(fullRec)}">${esc(cutRec)}</span></td>
            <td>${esc(fmtTimeHHMM(r["TIEMPO TOTAL EN LLAMADA"]))}</td>
            <td class="ga-right ga-col-puntos"><b>${fmtMetricVal(r.PUNTOS || 0, METRIC_PUNTOS)}</b></td>
            ${pesosCell}
            <td>${hasObs ? fmtReason(r.FLAG_REASON || "") : ""}</td>
            <td>
              <div class="ga-flag-actions">
                <button type="button" class="ga-btn-flag ga-btn-flag-edit" data-edit="pesos" aria-label="Cambiar monto" data-key="${esc(r.__key || "")}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1.767 1.767 0 0 1 2.5 2.5L12 14l-4 1 1-4Z"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", rowHtml);
      }
    }

    function renderAll(customRows){
      const baseRows = Array.isArray(customRows) ? customRows : state.rows;
      const rowsSelected = filterBySelection(baseRows);
      markDupFlags(rowsSelected);
      const rowsForMetrics = rowsSelected.filter(r => !isRejected(r));
      const totals = computeTotals(rowsForMetrics);

      const pTotal = qs("#smrTotal");
      const pMeta  = qs("#smrMeta");
      const pesosEl = qs("#gaPesos");
      const rowsEl  = qs("#gaRowsCount");

      // KPI visibility según métrica
      const puntosCard = qs("#smrTotal")?.closest(".ga-card");
      const pesosCard  = qs("#gaPesosCard");
      if (state.metric === METRIC_PUNTOS){
        if (puntosCard) puntosCard.style.display = "";
        if (pesosCard) pesosCard.style.display = "none";
      } else {
        if (puntosCard) puntosCard.style.display = "none";
        if (pesosCard) pesosCard.style.display = "";
      }

      if (pTotal) pTotal.textContent = totals.puntos.toLocaleString("es-CL");
      if (pMeta)  pMeta.textContent  = `${totals.count} filas`;
      if (pesosEl) pesosEl.textContent = fmtMetricVal(totals.pesos, METRIC_PESOS);
      if (rowsEl) rowsEl.textContent = `${totals.count} filas`;

      renderSummary(rowsForMetrics);
      renderChart(rowsForMetrics);
      renderRedFlags(rowsSelected);
      renderTable(rowsSelected);
    }

    async function load(){
      const startInp = qs("#smrStart");
      const endInp   = qs("#smrEnd");
      const sYMD = startInp ? String(startInp.value||"").trim() : "";
      const eYMD = endInp ? String(endInp.value||"").trim() : "";

      const start_ts = tzMidnightTsFromYMD(sYMD);
      const end_ts   = tzEndOfDayTsFromYMD(eYMD);

      if (!isFinite(start_ts) || !isFinite(end_ts)){
        setLoading(false);
        renderAll([]);
        return;
      }

      setLoading(true);

      try{
        const token = getToken();
        const url = `${ENDPOINT_LOG_MENSUAL}?action=report&scope=all&codep=${encodeURIComponent(auth.codep)}&start_ts=${encodeURIComponent(start_ts)}&end_ts=${encodeURIComponent(end_ts)}&limit=5000&_=${Date.now()}${token ? `&token=${encodeURIComponent(token)}` : ""}`;
        const res = await authFetch(url, { cache:"no-store" });
        const text = await res.text();

        let json;
        try{ json = JSON.parse(text); } catch(_){ throw new Error("Respuesta no es JSON válido"); }
        if (!json.ok) throw new Error(json.error || "Error en report");

        const allRows = Array.isArray(json.rows) ? json.rows : [];

        // rebuild consultores list
        const consMap = new Map();
        for (const r of allRows){
          const info = normalizeConsultor(r);
          if (!consMap.has(info.key)){
            consMap.set(info.key, info);
          }
        }
        state.consultores = Array.from(consMap.values()).sort((a,b)=>{
          const ida = Number(a.idc || a.name || a.display);
          const idb = Number(b.idc || b.name || b.display);
          const bothNum = isFinite(ida) && isFinite(idb);
          if (bothNum && ida !== idb) return ida - idb;
          const sa = String(a.idc || a.name || a.display || "");
          const sb = String(b.idc || b.name || b.display || "");
          return sa.localeCompare(sb, undefined, { numeric:true });
        });
        assignColors(state.consultores);

        // keep previous selection if possible; otherwise select all
        const previous = new Set(state.selectedKeys);
        const validPrev = Array.from(previous).filter(k => consMap.has(k));
        if (validPrev.length){
          state.selectedKeys = new Set(validPrev);
        } else {
          state.selectedKeys = new Set(state.consultores.map(c=>c.key));
        }
        state.rows = allRows.map(r=>({
          ...r,
          FLAG_STATUS: String(r.FLAG_STATUS || "").trim(),
          FLAG_REASON: String(r.FLAG_REASON || "").trim(),
          __key: `${r.__sheet || ""}#${r.__row || ""}`
        }));

        // UI sync
        updateConsBtnSummary();
        renderConsSelector(qs("#gaConsSearch")?.value || "");
        syncMetricUI();
        renderAll();
      }catch(_){
        state.rows = [];
        state.consultores = [];
        state.selectedKeys = new Set();
        updateConsBtnSummary();
        renderConsSelector(qs("#gaConsSearch")?.value || "");
        renderAll();
      }finally{
        setLoading(false);
      }
    }

    // UI hooks
    const metricBtns = qsa("[data-metric]");
    metricBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const m = btn.getAttribute("data-metric");
        if (!m || (m === METRIC_PESOS && !showPesos)) return;
        state.metric = m;
        syncMetricUI();
        renderAll();
      });
    });
    const periodBtns = qsa("[data-period]");
    periodBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const p = btn.getAttribute("data-period");
        if (!p || (p !== PERIOD_DAILY && p !== PERIOD_WEEKLY)) return;
        if (state.period === p) return;
        state.period = p;
        syncPeriodUI();
      });
    });

    function findRowByKey(key){
      return state.rows.find(r => (r.__key || `${r.__sheet || ""}#${r.__row || ""}`) === key);
    }
    async function sendFlagUpdate(row, status, reason){
      const token = getToken();
      if (!token) throw new Error("missing_token");
      const body = new URLSearchParams();
      body.append("action","flag");
      body.append("sheet", row.__sheet || "");
      body.append("row", String(row.__row || ""));
      body.append("status", status);
      body.append("reason", reason || "");
      body.append("token", token);
      const res = await authFetch(ENDPOINT_LOG_MENSUAL, { method:"POST", body });
      const text = await res.text();
      let json;
      try{ json = JSON.parse(text); }catch(_){ throw new Error("flag_update_invalid_response"); }
      if (!json.ok) throw new Error(json.error || "flag_update_error");
      return json;
    }
    async function sendAdjustUpdate(row, pesos, reason){
      const token = getToken();
      if (!token) throw new Error("missing_token");
      const body = new URLSearchParams();
      body.append("action","adjust");
      body.append("sheet", row.__sheet || "");
      body.append("row", String(row.__row || ""));
      body.append("pesos", String(pesos));
      body.append("reason", reason || "");
      body.append("token", token);
      const res = await authFetch(ENDPOINT_LOG_MENSUAL, { method:"POST", body });
      const text = await res.text();
      let json;
      try{ json = JSON.parse(text); }catch(_){ throw new Error("adjust_invalid_response"); }
      if (!json.ok) throw new Error(json.error || "adjust_error");
      return json;
    }

    const redBody = qs("#gaRedFlagsBody");
    if (redBody){
      redBody.addEventListener("click", async (ev)=>{
        const btn = ev.target && ev.target.closest && ev.target.closest("[data-flag]");
        if (!btn) return;
        const tr = btn.closest("tr[data-key]");
        if (!tr) return;
        const key = tr.getAttribute("data-key") || "";
        const action = btn.getAttribute("data-flag");
        const row = findRowByKey(key);
        if (!row) return;
        try{
          if (action === "accept"){
            await sendFlagUpdate(row, "accepted", "");
            row.FLAG_STATUS = "accepted";
            row.FLAG_REASON = "";
          } else if (action === "reject"){
            const reason = window.prompt("Motivo del rechazo:");
            if (reason === null) return; // cancelado
            const trimmed = String(reason || "").trim();
            if (!trimmed) return;
            await sendFlagUpdate(row, "rejected", trimmed);
            row.FLAG_STATUS = "rejected";
            row.FLAG_REASON = trimmed;
          } else {
            return;
          }
          renderAll();
        }catch(_){
          alert("No se pudo actualizar el estado. Intenta nuevamente.");
        }
      });
    }
    const histBody = qs("#smrTbody");
    if (histBody){
      histBody.addEventListener("click", async (ev)=>{
        const btn = ev.target && ev.target.closest && ev.target.closest("[data-edit='pesos']");
        if (!btn) return;
        const key = btn.getAttribute("data-key") || "";
        const row = findRowByKey(key);
        if (!row) return;
        const current = Number(row.PESOS || 0);
        const newValStr = window.prompt("Nuevo monto en pesos:", isFinite(current) ? String(current) : "");
        if (newValStr === null) return;
        const newVal = Number(newValStr);
        if (!isFinite(newVal)){
          alert("Monto inválido.");
          return;
        }
        const reason = window.prompt("Motivo del cambio:");
        if (reason === null) return;
        const trimmed = String(reason || "").trim();
        if (!trimmed){
          alert("Ingresa un motivo.");
          return;
        }
        try{
          await sendAdjustUpdate(row, newVal, trimmed);
          row.PESOS = newVal;
          row.FLAG_STATUS = "adjusted";
          row.FLAG_REASON = trimmed;
          renderAll();
        }catch(_){
          alert("No se pudo actualizar el monto. Intenta nuevamente.");
        }
      });
    }

    const consBtn = qs("#gaConsBtn");
    const consPop = qs("#gaConsPop");
    if (consBtn && consPop){
      consBtn.addEventListener("click",(ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        const open = consPop.style.display === "block";
        if (open) closeConsPop(); else openConsPop();
      });
      consPop.addEventListener("click",(ev)=> ev.stopPropagation());
      document.addEventListener("click", ()=> closeConsPop());
    }
    const consAll = qs("#gaConsAll");
    const consClear = qs("#gaConsClear");
    if (consAll){
      consAll.addEventListener("click",(ev)=>{
        ev.preventDefault();
        state.selectedKeys = new Set(state.consultores.map(c=>c.key));
        updateConsBtnSummary();
        renderConsSelector(qs("#gaConsSearch")?.value || "");
        renderAll();
      });
    }
    if (consClear){
      consClear.addEventListener("click",(ev)=>{
        ev.preventDefault();
        state.selectedKeys = new Set();
        updateConsBtnSummary();
        renderConsSelector(qs("#gaConsSearch")?.value || "");
        renderAll();
      });
    }
    const consSearch = qs("#gaConsSearch");
    if (consSearch){
      consSearch.addEventListener("input",(ev)=>{
        renderConsSelector(ev.target.value || "");
      });
    }

    // INIT
    initRangeUI();
    syncMetricUI();
    syncPeriodUI();
    updateConsBtnSummary();
    load();
  }
})();
</script>


</body>
</html>
