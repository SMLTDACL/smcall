<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" href="files/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Admin</title>
  <script>
    (function(){
      const LOGIN_URL = "../index.html";
      const TOKEN_KEY = "sm_token";
      const ALLOWED_CODEP = "863241943";
      let redirectingToLogin = false;
      function clearToken(){
        try{ sessionStorage.removeItem(TOKEN_KEY); }catch(_){}
      }
      function redirectToLogin(reason){
        if (redirectingToLogin) return;
        redirectingToLogin = true;
        clearToken();
        const sep = LOGIN_URL.includes("?") ? "&" : "?";
        const url = `${LOGIN_URL}${sep}r=${encodeURIComponent(reason || "token")}`;
        try{ window.location.replace(url); }catch(_){ window.location.href = url; }
      }
      function decodeTokenPayload(token){
        try{
          const parts = String(token || "").split(".");
          if (!parts[0]) return null;
          const json = atob(parts[0].replace(/-/g,"+").replace(/_/g,"/"));
          return JSON.parse(json);
        }catch(_){
          return null;
        }
      }
      function getToken(){
        const params = new URLSearchParams(location.search);
        const urlT = (params.get("t") || "").trim();
        if (urlT){
          try{ sessionStorage.setItem(TOKEN_KEY, urlT); }catch(_){}
          return urlT;
        }
        try{
          const st = sessionStorage.getItem(TOKEN_KEY);
          if (st) return st.trim();
        }catch(_){}
        return "";
      }
      function isTokenExpired(payload){
        const exp = Number(payload && payload.exp);
        if (!exp) return true;
        return Date.now() > exp * 1000;
      }
      function ensureAuth(){
        const params = new URLSearchParams(location.search);
        const token = getToken();
        const idc = (params.get("idc") || params.get("IDC") || "").trim();
        const codep = (params.get("codep") || "").trim();
        const payload = decodeTokenPayload(token);
        if (!token || !idc || !codep || !payload){
          redirectToLogin("token_missing");
          return null;
        }
        if (isTokenExpired(payload)){
          redirectToLogin("token_expired");
          return null;
        }
        const tokIdc = String(payload.idc || "").trim();
        const tokCodep = String(payload.codep || "").trim();
        if (tokIdc && tokIdc !== idc){
          redirectToLogin("token_idc_mismatch");
          return null;
        }
        if (tokCodep && tokCodep !== codep){
          redirectToLogin("token_codep_mismatch");
          return null;
        }
        if (codep !== ALLOWED_CODEP){
          redirectToLogin("codep_denied");
          return null;
        }
        return { token, idc, codep };
      }
      const auth = ensureAuth();
      if (auth) window.__smAuth = auth;
    })();
  </script>
  <!-- OpenReplay Tracking Code -->
  <script>
    // ===== 1) Obtener idc desde la URL =====
    function smGetIDCFromURL() {
      var search = window.location.search || "";
      if (!search) return "";
      try {
        // Navegadores modernos
        var params = new URLSearchParams(search);
        return params.get("idc") || "";
      } catch (e) {
        // Fallback simple por si acaso
        var m = search.match(/[?&]idc=([^&]+)/i);
        return m ? decodeURIComponent(m[1].replace(/\+/g, " ")) : "";
      }
    }

    // Guardamos el idc para usarlo como userID
    var smIDC = smGetIDCFromURL();
    window.__smIDC = smIDC; // por si lo quieres usar en otras partes de tu app

    // ===== 2) Configuración OpenReplay =====
    var initOpts = {
      projectKey: "QonwVB9oKHTLvpz3EkMc",
      // 0 - plain, 1 - obscured, 2 - ignored
      defaultInputMode: 0,
      obscureTextNumbers: false,
      obscureTextEmails: false
    };

    // Aquí conectamos el idc al userID
    var startOpts = { userID: smIDC || "" };

    (function(A,s,a,y,e,r){
      r = window.OpenReplay = [e, r, y, [s - 1, e]];
      s = document.createElement('script');
      s.src = A;
      s.async = !a;
      document.getElementsByTagName('head')[0].appendChild(s);

      r.start = function(v){ r.push([0]); };
      r.stop = function(v){ r.push([1]); };
      r.setUserID = function(id){ r.push([2, id]); };
      r.setUserAnonymousID = function(id){ r.push([3, id]); };
      r.setMetadata = function(k, v){ r.push([4, k, v]); };
      r.event = function(k, p, i){ r.push([5, k, p, i]); };
      r.issue = function(k, p){ r.push([6, k, p]); };
      r.isActive = function(){ return false; };
      r.getSessionToken = function(){};
    })("//static.openreplay.com/latest/openreplay-assist.js", 1, 0, initOpts, startOpts);

    // (Opcional) Si quieres forzar el setUserID explícito cuando exista idc:
    (function(){
      if (!smIDC) return;
      try {
        if (window.OpenReplay && typeof OpenReplay.setUserID === "function") {
          OpenReplay.setUserID(smIDC);
        }
      } catch (e) {}
    })();
  </script>
</head>
<body>

<div class="sm-admin-wrap">
  <div id="sm-admin-loader" class="sm-skeletons" style="display:block;">
    <div class="sm-skel-card sm-skel-filters"></div>
    <div class="sm-skel-card sm-skel-list"></div>
    <div class="sm-skel-card sm-skel-config"></div>
  </div>
  <div id="sm-admin-content" style="display:none;">
  <!-- Panel Administración (agenda del día) -->
  <div class="sm-admin-card sm-admin-filters-card">
    <div class="sm-admin-bar">
      <div>
        <label class="sm-label">Fecha
          <input id="sm-admin-date" class="sm-input" type="date">
        </label>
      </div>
      <div>
        <label class="sm-label">Consultor
          <select id="sm-admin-consultor" class="sm-select"></select>
        </label>
      </div>
    </div>
  </div>
  <div id="sm-admin-panel" class="sm-admin-card">
    <!-- Listado de agendamientos -->
    <div class="sm-admin-list-header">
      <div class="sm-subtitle" style="margin-top:0;">Agendamientos del día</div>
      <button id="sm-admin-refresh-btn" class="sm-admin-refresh-btn" type="button" title="Actualizar listado">
        <span aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        </span>
        <span>Actualizar</span>
      </button>
    </div>
    <div id="sm-admin-list" class="sm-admin-list"></div>
    <div id="sm-admin-count" class="sm-admin-count"></div>
  </div>
  <!-- Panel Configuración (card separado) -->
  <div id="sm-admin-config-card" class="sm-admin-card" style="margin-top: 40px;">
    <details class="sm-config" id="sm-config">
      <summary class="sm-config-summary">
        <span>Configuración</span>
        <span class="sm-config-chevron" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg"
               width="20" height="20"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="lucide lucide-chevron-down-icon lucide-chevron-down">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </span>
      </summary>
      <div class="sm-config-body">
        <!-- Bloqueo de fechas -->
        <hr style="margin:18px 0; border:none;border-top:1px solid #e5e7eb;">
        <h3 class="sm-subtitle">Bloqueo de fechas</h3>
        <div class="sm-admin-bar">
          <div>
            <label class="sm-label">Fecha a bloquear
              <input id="sm-block-date" class="sm-input" type="date">
            </label>
          </div>
          <div>
            <label class="sm-label">Consultor
              <select id="sm-block-consultor" class="sm-select"></select>
            </label>
          </div>
          <div>
            <label class="sm-label">Motivo (opcional)
              <input id="sm-block-motivo" class="sm-input" type="text">
            </label>
          </div>
          <div style="display:flex;gap:6px;align-items:flex-end;">
            <button id="sm-btn-block" class="sm-btn-secondary" type="button">Bloquear</button>
            <button id="sm-btn-unblock" class="sm-btn-secondary" type="button">Desbloquear</button>
          </div>
        </div>
        <div class="sm-subtitle sm-block-title">Fechas bloqueadas</div>
        <div id="sm-block-list" class="sm-block-list"></div>
        <!-- Edición horario de cada consultor -->
        <hr style="margin:18px 0; border:none;border-top:1px solid #e5e7eb;">
        <h3 class="sm-subtitle">Horarios de consultor</h3>
        <div class="sm-admin-bar">
          <div>
            <label class="sm-label">Consultor
              <select id="sm-hor-consultor" class="sm-select"></select>
            </label>
          </div>
          <div class="sm-admin-info">
            Edita qué días atiende y en qué tramos.
          </div>
        </div>
        <div id="sm-hor-grid" class="sm-hor-grid"></div>
        <div class="sm-hor-meta">
          <label class="sm-label" for="sm-hor-days-ahead">Máximo de días a futuro</label>
          <div class="sm-hor-meta-row">
            <input id="sm-hor-days-ahead" class="sm-input sm-input-inline" type="number" min="1" placeholder="Sin restricción">
            <div class="sm-hor-meta-hint">
              Deja en blanco para sin restricción. Se calcula por medianoche (1 = solo hoy, 2 = hoy y mañana, etc.).
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;justify-content:flex-start;">
          <button id="sm-hor-save" class="sm-btn-secondary" type="button">Guardar horarios</button>
        </div>
        <!-- Gestión simple de consultores (crear) -->
        <hr style="margin:18px 0; border:none;border-top:1px solid #e5e7eb;">
        <h3 class="sm-subtitle">Consultores</h3>
        <div class="sm-admin-bar">
          <div>
            <label class="sm-label">Nuevo ID (ej: 003)
              <input id="sm-new-consultor-id" class="sm-input" type="text">
            </label>
          </div>
          <div>
            <label class="sm-label">Nombre
              <input id="sm-new-consultor-name" class="sm-input" type="text">
            </label>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <button id="sm-btn-add-consultor" class="sm-btn-secondary" type="button">Agregar consultor</button>
          </div>
        </div>
                <!-- Listado de consultores activos (para eliminar) -->
        <div id="sm-consultor-list" class="sm-cons-list"></div>
      </div>
    </details>
  </div>
  </div>
  <!-- Modal Reasignar -->
  <div id="sm-rea-modal" class="sm-rea-modal">
    <div class="sm-rea-backdrop"></div>
    <div class="sm-rea-dialog">
      <div class="sm-rea-title">Reasignar reunión</div>
      <div class="sm-rea-body" id="sm-rea-body">
        Buscando consultores disponibles…
      </div>
      <div class="sm-rea-row" id="sm-rea-select-row" style="display:none;">
        <label for="sm-rea-select">Nuevo consultor</label>
        <select id="sm-rea-select"></select>
      </div>
      <div class="sm-rea-footer">
        <button type="button" class="sm-rea-btn" id="sm-rea-cancel">Cerrar</button>
        <button type="button" class="sm-rea-btn sm-rea-btn-primary" id="sm-rea-confirm" disabled>Reasignar</button>
      </div>
    </div>
  </div>
  <!-- Modal Reprogramar -->
  <div id="sm-rp-modal" class="sm-rp-modal">
    <div class="sm-rp-backdrop"></div>
    <div class="sm-rp-dialog">
      <div class="sm-rp-title">Reprogramar reunión</div>
      <div class="sm-rp-body" id="sm-rp-body">
        Selecciona una nueva fecha y horario.
      </div>
      <div class="sm-rp-grid">
        <div class="sm-rp-cal-wrap">
          <div id="sm-rp-cal" class="sm-rp-cal">Cargando calendario…</div>
        </div>
        <div class="sm-rp-slots-wrap">
          <div class="sm-rp-date-label" id="sm-rp-date-label">Selecciona una fecha</div>
          <div id="sm-rp-slots" class="sm-rp-slots"></div>
        </div>
      </div>
      <div class="sm-rp-footer">
        <button type="button" class="sm-rp-btn" id="sm-rp-cancel">Cerrar</button>
        <button type="button" class="sm-rp-btn sm-rp-btn-primary" id="sm-rp-confirm" disabled>Reprogramar</button>
      </div>
    </div>
  </div>
  <!-- Toast + Loader -->
  <div id="sm-admin-toast" class="sm-toast"></div>
</div>
<style>
:root{
  font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
body{
  margin:0;
  font-family:inherit;
  -webkit-font-smoothing:antialiased;
  background:#F5F5F7;
}
    /* ===== Base Admin ===== */
.sm-admin-wrap{
  font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  padding:24px 0;
  margin: 18px;
}
.sm-admin-card{
  max-width:92%;
  margin:0 auto 18px;
  background:#fff;
  border-radius:18px;
  padding:20px;
}
.sm-admin-bar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:flex-end;
  margin-top:8px;
}
.sm-admin-list{
  margin-top:8px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  padding:10px;
  max-height:420px;
  overflow:auto;
}
.sm-admin-count{
  margin-top:20px;
  margin-left: 25px;
  font-size:13px;
  font-weight:400;
  color:#111827;
}
.sm-admin-list-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
  gap:12px;
}
.sm-admin-refresh-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border:1px solid #ffffff;
  background:#f5f5f7;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  color:#111827;
}
.sm-admin-refresh-btn:hover{
  background:#f3f4f6;
}
.sm-admin-refresh-btn:active{
  transform:translateY(1px);
}
.sm-admin-item{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  padding:6px 8px;
  border-radius:10px;
  margin-bottom:4px;
  font-size:13px;
}
.sm-admin-item.is-past{opacity:0.45;}
.sm-admin-item.is-now{
  border:1px solid #e5e7eb;
}
.sm-admin-item.is-now-pending{
  background:#f3f4f6;
  border:1px solid #e5e7eb;
}
.sm-admin-item.is-now-present{
  background:#ecfdf3;
  border:1px solid #bbf7d0;
}
.sm-admin-item.is-now-missing{
  background:#fff7ed;
  border:1px solid #fdba74;
}
.sm-admin-item.is-cancelled{
  text-decoration:line-through;
  opacity:0.55;
}
.sm-admin-item-main{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
.sm-admin-badge{
  border-radius:999px;
  padding:2px 8px;
  font-size:11px;
  background:#e5e7eb;
  color:#111827;
}
.sm-admin-badge-consultor{
  background:#eff6ff;
  color:#1d4ed8;
  font-weight: 600;
}
.sm-admin-badge-hora{
  background:#f3f4f6;
  color:#111827;
}
.sm-admin-badge-cancel{
  background:#fee2e2;
  color:#b91c1c;
}
.sm-admin-badge-delay{
  background: #e5e7eb;
  color: #374151;
}
.sm-admin-badge-noshow{
  background:#fee2e2;
  color:#b91c1c;
  font-weight:600;
}
.sm-admin-actions{
  display:flex;
  gap:6px;
}
.sm-admin-btn{
  border:none;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
  background:#e5e7eb;
  color:#111827;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.sm-admin-btn-icon{
  padding:4px 8px;
}
.sm-admin-btn svg{
  width:18px;
  height:18px;
  display:block;
}
.sm-admin-btn-orange{
  background:#ffeadc;
  color:#ea580c;
}
.sm-admin-btn-yellow{
  background:#f9f2b8;
  color:#6d6521;
}
.sm-admin-btn-red{
  background:#fee2e2;
  color:#b91c1c;
}
.smc-fly-tooltip{
  position:fixed;
  background:#071E34;
  color:#fff;
  font-size:11px;
  padding:5px 8px;
  border-radius:6px;
  white-space:nowrap;
  box-shadow:0 8px 24px rgba(0,0,0,.18);
  z-index:2147483647;
  pointer-events:none;
}

.sm-admin-info{
  font-size:12px;
  color:#6b7280;
}
.sm-label{
  display:block;
  font-size:13px;
  color:#374151;
  margin-bottom:2px;
  font-weight:500;
}
.sm-input,.sm-select{
  width:100%;
  padding:7px 9px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:13px;
  box-sizing:border-box;
}
#sm-admin-date{
  line-height: 15px;
}

#sm-block-date{
  line-height: 15px;
}

.sm-input:focus,.sm-select:focus{
  outline:none;
  border-color:#1f6feb;
  box-shadow:0 0 0 1px rgba(31,111,235,0.07);
}
.sm-row{margin-bottom:10px;}
.sm-title{
  margin:0 0 8px;
  font-size:22px;
  font-weight:700;
  color:#111827;
}
.sm-subtitle{
  margin:0 0 6px;
  font-size:15px;
  font-weight:600;
  color:#111827;
}
.sm-btn-primary,.sm-btn-secondary{
  border:none;
  border-radius:999px;
  padding:8px 12px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}
.sm-btn-primary{
  background:#1f6feb;
  color:#fff;
  width:100%;
}
.sm-btn-secondary{
  background:#e5e7eb;
  color:#111827;
}

/* Toast + Loader */
.sm-toast{
  position:fixed;
  left:50%;
  bottom:20px;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:10px 14px;
  border-radius:999px;
  font-size:13px;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s,transform .2s;
  z-index:99999;
}
.sm-toast.is-show{
  opacity:1;
  transform:translateX(-50%) translateY(-4px);
}
.sm-skeletons{
  max-width:92%;
  margin:0 auto 18px;
  display:none;
}
.sm-skel-card{
  height:120px;
  border-radius:18px;
  margin-bottom:18px;
  background:linear-gradient(90deg,#e5e7eb,#dcdfe3,#e5e7eb);
  background-size:200% 100%;
  animation:smShimmer 1.2s infinite linear;
}
.sm-skel-filters{height:110px;}
.sm-skel-list{height:360px;}
.sm-skel-config{height:100px;}
@keyframes smShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Botón naranja para Reprogramar / Reasignar */
.sm-admin-actions .sm-admin-btn-orange{
  background:#ffeadc !important;
  color:#ea580c !important;
}



/* ===== Modal Reasignar ===== */
.sm-rea-modal{
  position:fixed;
  inset:0;
  z-index:99990;
  display:none;
  align-items:center;
  justify-content:center;
}
.sm-rea-backdrop{
  position:absolute;
  inset:0;
  background:rgba(15,23,42,0.45);
}
.sm-rea-dialog{
  position:relative;
  background:#ffffff;
  border-radius:18px;
  max-width:420px;
  width:90%;
  padding:18px 18px 14px;
  box-shadow:0 18px 45px rgba(15,23,42,0.22);
  font-family:inherit;
  z-index:1;
}
.sm-rea-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:4px;
  color:#111827;
}
.sm-rea-body{
  font-size:14px;
  color:#4b5563;
  margin-bottom:10px;
}
.sm-rea-row{
  margin-bottom:10px;
}
.sm-rea-row label{
  display:block;
  font-size:12px;
  color:#6b7280;
  margin-bottom:4px;
}
.sm-rea-row select{
  width:100%;
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:6px 10px;
  font-size:13px;
  background:#f9fafb;
  outline:none;
}
.sm-rea-footer{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:8px;
}
.sm-rea-btn{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:6px 14px;
  font-size:13px;
  background:#f9fafb;
  cursor:pointer;
}
.sm-rea-btn-primary{
  background:#1f6feb;
  color:#ffffff;
  border-color:#1f6feb;
}

/* ===== Modal Reprogramar ===== */
.sm-rp-modal{
  position:fixed;
  inset:0;
  z-index:99989;
  display:none;
  align-items:center;
  justify-content:center;
}
.sm-rp-backdrop{
  position:absolute;
  inset:0;
  background:rgba(15,23,42,0.45);
}
.sm-rp-dialog{
  position:relative;
  background:#ffffff;
  border-radius:18px;
  max-width:480px;
  width:95%;
  padding:16px 16px 14px;
  box-shadow:0 18px 45px rgba(15,23,42,0.22);
  font-family:inherit;
  z-index:1;
}
.sm-rp-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:4px;
  color:#111827;
}
.sm-rp-body{
  font-size:14px;
  color:#4b5563;
  margin-bottom:10px;
}
.sm-rp-grid{
  display:grid;
  grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
  gap:12px;
  align-items:flex-start;
}
.sm-rp-cal-wrap{
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:10px;
  background:#f9fafb;
}
.sm-rp-slots-wrap{
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:10px;
  background:#ffffff;
  min-height:150px;
  font-size:13px;
}
.sm-rp-date-label{
  font-size:13px;
  font-weight:500;
  margin-bottom:6px;
  color:#111827;
}
.sm-rp-slots{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.sm-rp-slot-btn{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:4px 10px;
  font-size:12px;
  background:#f9fafb;
  cursor:pointer;
}
.sm-rp-slot-btn.selected{
  background:#1f6feb;
  color:#ffffff;
  border-color:#1f6feb;
}
.sm-rp-footer{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:10px;
}
.sm-rp-btn{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:6px 14px;
  font-size:13px;
  background:#f9fafb;
  cursor:pointer;
}
.sm-rp-btn-primary{
  background:#1f6feb;
  color:#ffffff;
  border-color:#1f6feb;
}
.sm-rp-cal{
  font-size:12px;
}
.sm-rp-cal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.sm-rp-cal-month{
  font-weight:600;
  font-size:13px;
  color:#111827;
}
.sm-rp-cal-nav button{
  border-radius:999px;
  border:1px solid #d1d5db;
  width:24px;
  height:24px;
  font-size:13px;
  background:#ffffff;
  cursor:pointer;
}
.sm-rp-cal-grid{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:2px;
}
.sm-rp-dow{
  text-align:center;
  font-size:11px;
  color:#9ca3af;
  padding:2px 0;
}
.sm-rp-day-btn{
  border-radius:999px;
  border:none;
  padding:3px 0;
  font-size:11px;
  cursor:pointer;
  background:transparent;
}
.sm-rp-day-btn.disabled{
  cursor:default;
  color:#d1d5db;
}
.sm-rp-day-btn.available{
  color:#111827;
}
.sm-rp-day-btn.available:hover{
  background:#e5e7eb;
}
.sm-rp-day-btn.selected{
  background:#1f6feb;
  color:#ffffff;
}
@media (max-width:640px){
  .sm-rp-grid{
    grid-template-columns:minmax(0,1fr);
  }
}


/* ===== Editor de horarios por consultor ===== */
.sm-hor-grid{
  margin-top:10px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  padding:10px;
}

.sm-hor-meta{
  margin-top:12px;
}
.sm-hor-meta-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
}
.sm-input-inline{
  max-width:180px;
}
.sm-hor-meta-hint{
  font-size:12px;
  color:#6b7280;
  line-height:1.4;
}

.sm-hor-row{
  display:grid;
  grid-template-columns:90px minmax(0,1fr);
  gap:6px 10px;
  align-items:flex-start;
  padding:6px 8px;
  border-radius:10px;
}
.sm-hor-row:nth-child(odd){
  background:#ffffff;
}

.sm-hor-day-label{
  font-size:13px;
  font-weight:500;
  color:#111827;
}

.sm-hor-day-label input{
  margin-right:6px;
}

.sm-hor-fields{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.sm-hor-range{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  align-items:center;
  font-size:12px;
}
.sm-hor-range-label{
  font-size:11px;
  color:#6b7280;
  margin-right:4px;
}

.sm-hor-select{
  min-width:90px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #d1d5db;
  font-size:12px;
  background:#ffffff;
  box-sizing:border-box;
}
.sm-hor-select:disabled{
  background:#e5e7eb;
  color:#9ca3af;
}




/* ===== Configuración colapsable ===== */
.sm-config{
  margin-top:5px;
}

.sm-config-summary{
    list-style: none;
    display: flex;
    cursor: pointer;
    font-size: 20px;
    font-weight: 700;
    color: #111827;
    align-items: center;
}

/* Oculta el triángulo por defecto del summary */
.sm-config-summary::-webkit-details-marker{
  display:none;
}

.sm-config-chevron{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  transition:transform .18s ease;
}

/* Tamaño del SVG */
.sm-config-chevron svg{
  width:20px;
  height:20px;
}

/* Rota la flecha cuando está abierto */
.sm-config[open] .sm-config-chevron{
  transform:rotate(180deg);
}

.sm-config-body{
  margin-top:10px;
}




/* ===== Bloqueo de fechas (listado) ===== */
.sm-block-title{
  margin-top:10px;
}

.sm-block-list{
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  padding:8px;
  font-size:13px;
  margin-top:10px;
}

.sm-block-row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
  padding:6px 8px;
  border-radius:10px;
}

.sm-block-row:nth-child(odd){
  background:#ffffff;
}

.sm-block-info{
  display:flex;
  flex-direction:column;
  gap:2px;
  min-width:0;
}

.sm-block-date{
  font-weight:600;
  color:#111827;
}

.sm-block-consultor{
  font-size:12px;
  color:#374151;
}

.sm-block-motivo{
  font-size:12px;
  color:#6b7280;
  word-break:break-word;
}

.sm-block-delete-btn{
  border:none;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
  background:#fee2e2;
  color:#b91c1c;
}

/* ===== Listado de consultores (eliminar) ===== */
.sm-cons-list{
  margin-top:10px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  padding:8px;
  font-size:13px;
}

.sm-cons-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:5px 6px;
  border-radius:8px;
}

.sm-cons-row:nth-child(odd){
  background:#ffffff;
}

.sm-cons-info{
  display:flex;
  align-items:center;
  gap:4px;
}

.sm-cons-id{
  font-weight:600;
  font-size:12px;
  padding:2px 6px;
  border-radius:999px;
  background:#eff6ff;
  color:#1d4ed8;
}

.sm-cons-delete-btn{
  border:none;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
  background:#fee2e2;
  color:#b91c1c;
}




/* ===== Admin: Filas tipo 'consultores' (IDPipe/Teléfono copiar + nombre + tipo) ===== */

/* Más parecido a consultores (separación mayor entre “piezas”) */
.sm-admin-item-main{
  gap:20px; /* antes 8px */
}

/* Row compacto que NO ocupa el ancho completo (para que quede al lado, no apilado) */
.smad-info-row{
  display:inline-flex; /* clave: inline-flex, no block */
  align-items:center;
  gap:2px;
  font-size:13px;
}

/* Valor */
.smad-info-value{
  color:#111827;
}

/* Botón copiar (igual que consultores) */
.smad-copy-btn{
  border:none;
  background:transparent;
  padding:0;
  margin-left:2px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.smad-copy-btn svg{
  width:13px;
  height:13px;
  stroke:#6b7280;
}

.smad-copy-btn:hover svg{
  stroke:#111827;
}

/* Badge tipo (igual estilo consultores) */
.smad-badge-tipo{
  font-size:11px;
  padding:2px 6px;
  border-radius:999px;
  background:#e5e7eb;
  color:#374151;
}

.smad-info-row-motivo{
  margin-top: 4px;
}

.smad-info-value-motivo{
  max-width: 150px;
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

</style>
<script>
(function(){
  // ENDPOINT_CALENDAR (principal):
  // - Web App de Google Apps Script (URL /exec).
  // - Este es el backend principal que recibe los datos del front.
  // - Nota: aunque copies el código a tu PC, esta URL sigue apuntando al despliegue en Google.
  // - Código fuente (copia local para editar/analizar con Codex): /apps-script/code.gs
  const ENDPOINT_CALENDAR = "https://script.google.com/macros/s/AKfycbxluSUVEHa-jeX-QSJknVE5ZfdiBFMCm7qw3oc-9wNZ_4kT2CnW_2OZNUFZzZZtWr5e/exec";
  // Endpoint de presencia (Venta / call)
  const ENDPOINT_CALL = "https://script.google.com/macros/s/AKfycbwnZkcBrj3UJkxAMC3dgxxsWfdsUpni6SYuW2f2DANDHJZGZPod_A_hBd6Q3mumtiPn/exec";
  const PRESENCE_LOOKBACK_MINUTES = 10;
  const PRESENCE_RETRY_MS = 60 * 1000;

  const PRESENCE_WINDOW_ADVANCE_MIN = 5; // minutos antes del inicio para marcar "en curso"
  const PRESENCE_SLOT_DURATION_MIN = 30;
  const REFRESH_ALIGN_MS = 15 * 60 * 1000;
  const REFRESH_OFFSET_MS = 5 * 60 * 1000; // mueve los cortes a 55/10/25/40

  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  let gConsultores = [];
  let currentReassignBooking = null;
  let currentReprogBooking   = null;
  let presenceWatchers = new Map();
  let presenceGeneration = 0;
  let presenceGreens = new Set();
  // Marca cuándo se recargaron los agendamientos por última vez (para saber si se saltó un cuarto)
  let lastBookingReloadMs = Date.now();

  // Ticker “robusto” para tareas periódicas aun si el navegador ralentiza timers
  function runEveryAligned(ms, fn, offsetMs = 0){
    let timeout = null;
    const step = ()=>{
      fn();
      const now = Date.now();
      const next = Math.ceil((now + offsetMs) / ms) * ms - offsetMs;
      const delay = Math.max(500, next - now);
      timeout = setTimeout(step, delay);
    };
    step();
    return ()=> { if (timeout) clearTimeout(timeout); };
  }

  function onResume(fn){
    let last = document.visibilityState;
    document.addEventListener("visibilitychange", ()=>{
      if (last === "hidden" && document.visibilityState === "visible"){
        try{ fn(); }catch(err){ console.error(err); }
      }
      last = document.visibilityState;
    });
    window.addEventListener("focus", ()=>{
      try{ fn(); }catch(err){ console.error(err); }
    });
  }

  // Estado del popup de reprogramación
  let rpState = {
    inited: false,
    today: null,
    days_ahead_max: 90,
    global_days_ahead_max: 90,
    consultorId: null,
    currentMonth: null,
    availableDays: {},
    selectedDate: null,
    selectedTime: null
  };

  function consultorCapDays(cid){
    const base = rpState.global_days_ahead_max || 90;
    const c = getConsultorById(cid);
    const raw = c && c.days_ahead_limit != null ? Number(c.days_ahead_limit) : null;
    if (raw == null || !Number.isFinite(raw) || raw < 1) return base;
    return Math.min(base, Math.floor(raw));
  }

  // ===== Helpers básicos =====
  function toast(msg, ms=1800){
    const t = qs("#sm-admin-toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("is-show");
    setTimeout(()=> t.classList.remove("is-show"), ms);
  }

  function showLoader(show){
    const skeleton = qs("#sm-admin-loader");
    const content = qs("#sm-admin-content");
    if (skeleton) skeleton.style.display = show ? "block" : "none";
    if (content) content.style.display = show ? "none" : "";
  }

  // ====== copiar al portapapeles (igual a consultores) ======
  function copyToClipboard(text){
    if (!text) return;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text)
        .then(()=> toast("Copiado"))
        .catch(err=>{
          console.error(err);
          toast("No se pudo copiar");
        });
    } else {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        toast("Copiado");
      }catch(err){
        console.error(err);
        toast("No se pudo copiar");
      }
      document.body.removeChild(ta);
    }
  }

  // acepta displayValue para mostrar truncado pero copiar el valor completo
  function makeCopyRow(value, displayValue){
    if (!value) return null;

    const shown = displayValue || value;

    const row = document.createElement("div");
    row.className = "smad-info-row";

    const spanValue = document.createElement("span");
    spanValue.className = "smad-info-value";
    spanValue.textContent = shown;

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "smad-copy-btn";
    btn.innerHTML =
      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" ' +
      'viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ' +
      'stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon lucide-copy">' +
      '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>' +
      '<path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>' +
      '</svg>';

    btn.addEventListener("click", ()=> copyToClipboard(value));

    row.append(spanValue, btn);
    return row;
  }
  // ====== FIN copiar ======

  function pad2(n){ return n<10 ? "0"+n : ""+n; }

  function ymdToday(){
    const d = new Date();
    return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  }

  function formatDateDDMMYYYY(ymd){
    const p = String(ymd || "").split("-");
    if (p.length === 3 && p[0].length === 4) return [p[2], p[1], p[0]].join("-");
    return ymd || "";
  }

  function normTime(hhmm){
    if (!hhmm) return "";
    const p = String(hhmm).split(":");
    const h = Number(p[0]) || 0;
    const m = Number(p[1]) || 0;
    return pad2(h)+":"+pad2(m);
  }

  function parseMinutes(hhmm){
    if (!hhmm) return null;
    const p = String(hhmm).split(":");
    if (p.length < 2) return null;
    const h = Number(p[0]), m = Number(p[1]);
    if (isNaN(h) || isNaN(m)) return null;
    return h*60 + m;
  }

  function presenceKey(b){
    return String(b.booking_id || b.idpipe || (b.fecha+"_"+b.hora+"_"+b.consultor_id));
  }

  function clearPresenceWatchers(){
    presenceGeneration += 1;
    presenceWatchers.forEach(w=>{
      if (w && w.timer) clearInterval(w.timer);
    });
    presenceWatchers.clear();
  }

  function applyPresenceClass(el, status){
    if (!el) return;
    el.classList.remove("is-now-present","is-now-missing","is-now-pending");
    if (status === "present"){
      el.classList.add("is-now","is-now-present");
    } else if (status === "missing"){
      el.classList.add("is-now","is-now-missing");
    } else if (status === "pending"){
      el.classList.add("is-now","is-now-pending");
    }
  }

  function parsePresenceTs(ts){
    if (!ts) return 0;
    const clean = String(ts).trim().replace(" ", "T");
    const ms = Date.parse(clean);
    return isNaN(ms) ? 0 : ms;
  }

  function bookingWindowMs(booking){
    const hhmm = normTime(booking.hora || "");
    const dateStr = String(booking.fecha || "").trim();
    if (!hhmm || !dateStr) return null;
    const start = new Date(`${dateStr}T${hhmm}:00`);
    if (isNaN(start.getTime())) return null;
    const startMs = start.getTime();
    const endMs = startMs + (PRESENCE_SLOT_DURATION_MIN * 60 * 1000);
    const monitorStartMs = startMs - (PRESENCE_WINDOW_ADVANCE_MIN * 60 * 1000);
    const monitorEndMs = startMs + ((PRESENCE_SLOT_DURATION_MIN - PRESENCE_WINDOW_ADVANCE_MIN) * 60 * 1000);
    // monitorStart/End delimit cuándo el front consulta presencia; validación usa startMs/endMs y lookback
    return { startMs, endMs, monitorStartMs, monitorEndMs };
  }

  // ===== API GETs =====
  async function apiGetConsultores(){
    const url = ENDPOINT_CALENDAR+"?mode=consultores&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("consultores "+res.status);
    return res.json();
  }

  async function apiListBookings(dateStr, consultor){
    const url = ENDPOINT_CALENDAR+"?mode=listBookings"
      +"&date="+encodeURIComponent(dateStr)
      +"&consultor="+encodeURIComponent(consultor)
      +"&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("listBookings "+res.status);
    return res.json();
  }

  async function apiPresenceStatus(idpipe){
    const url = ENDPOINT_CALL+"?mode=presence_status"
      +"&idpipe="+encodeURIComponent(idpipe)
      +"&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("presence_status "+res.status);
    return res.json();
  }

  async function apiSlots(consultor_id, fecha){
    const url = ENDPOINT_CALENDAR+"?mode=slots"
      +"&consultor="+encodeURIComponent(consultor_id)
      +"&date="+encodeURIComponent(fecha)
      +"&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("slots "+res.status);
    return res.json();
  }

  async function apiAvailableDays(consultor, from, to){
    const url = ENDPOINT_CALENDAR+"?mode=availableDays"
      +"&consultor="+encodeURIComponent(consultor)
      +"&from="+encodeURIComponent(from)
      +"&to="+encodeURIComponent(to)
      +"&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("availableDays "+res.status);
    return res.json();
  }

  async function apiInitBooking(){
    const url = ENDPOINT_CALENDAR+"?mode=init_booking&_="+Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("init_booking "+res.status);
    return res.json();
  }

  async function apiListBlocks(consultor_id){
    const cid = consultor_id || "ALL";
    const url = ENDPOINT_CALENDAR+"?mode=blocks"
      +"&consultor="+encodeURIComponent(cid)
      +"&_="+Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("blocks "+res.status);
    return res.json();
  }

  // ===== API POSTs =====
  async function apiBook(payload){
    const body = new URLSearchParams();
    body.append("mode","book");
    Object.entries(payload).forEach(([k,v])=>{
      if (v !== undefined && v !== null) body.append(k, v);
    });
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("book "+res.status);
    return res.json();
  }

  async function apiCancel(booking_id, motivo){
    const body = new URLSearchParams();
    body.append("mode","cancel");
    body.append("booking_id", booking_id);
    body.append("motivo", motivo || "");
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("cancel "+res.status);
    return res.json();
  }

  async function apiBlockDate(fecha, consultor_id, motivo){
    const body = new URLSearchParams();
    body.append("mode","blockDate");
    body.append("fecha", fecha);
    body.append("consultor_id", consultor_id);
    body.append("motivo", motivo || "");
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("blockDate "+res.status);
    return res.json();
  }

  async function apiUnblockDate(fecha, consultor_id){
    const body = new URLSearchParams();
    body.append("mode","unblockDate");
    body.append("fecha", fecha);
    body.append("consultor_id", consultor_id);
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("unblockDate "+res.status);
    return res.json();
  }

  async function apiAddConsultor(id, nombre){
    const body = new URLSearchParams();
    body.append("mode","addConsultor");
    body.append("consultor_id", id);
    body.append("nombre", nombre || "");
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("addConsultor "+res.status);
    return res.json();
  }

  async function apiDeleteConsultor(id){
    const body = new URLSearchParams();
    body.append("mode","deleteConsultor");
    body.append("consultor_id", id);
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("deleteConsultor "+res.status);
    return res.json();
  }

  // ====== HORARIOS POR CONSULTOR (Admin) ======
  const SM_HOR_TIMES = (function(){
    const arr = [""];
    for (let h=0; h<24; h++){
      for (let m of [0,30]){
        arr.push(pad2(h)+":"+pad2(m));
      }
    }
    return arr;
  })();

  async function apiGetSchedule(consultor_id){
    const url = ENDPOINT_CALENDAR+"?mode=schedule"
      +"&consultor="+encodeURIComponent(consultor_id)
      +"&_="+Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("schedule "+res.status);
    return res.json();
  }

  async function apiSaveSchedule(consultor_id, schedule, daysAheadLimit){
    const body = new URLSearchParams();
    body.append("mode","saveSchedule");
    body.append("consultor_id", consultor_id);
    body.append("days", JSON.stringify(schedule));
    body.append("days_ahead_limit", daysAheadLimit == null ? "" : daysAheadLimit);
    const res = await fetch(ENDPOINT_CALENDAR, { method:"POST", body });
    if (!res.ok) throw new Error("saveSchedule "+res.status);
    return res.json();
  }

  function smHorDayName(dow){
    const names = { 1:"Lunes",2:"Martes",3:"Miércoles",4:"Jueves",5:"Viernes",6:"Sábado",7:"Domingo" };
    return names[dow] || ("Día "+dow);
  }

  function renderScheduleEditor(schedule){
    const grid = qs("#sm-hor-grid");
    if (!grid) return;
    grid.innerHTML = "";

    const byDow = {};
    for (let d=1; d<=7; d++){
      byDow[d] = { dow:d, enabled:false, start1:"", end1:"", start2:"", end2:"" };
    }

    (schedule || []).forEach(row=>{
      const d = Number(row.dow || row.dia || row.dia_semana || 0);
      if (d>=1 && d<=7){
        byDow[d] = {
          dow: d,
          enabled: !!row.enabled,
          start1: row.start1 || "",
          end1: row.end1 || "",
          start2: row.start2 || "",
          end2: row.end2 || ""
        };
      }
    });

    for (let d=1; d<=7; d++){
      const cfg = byDow[d];

      const rowEl = document.createElement("div");
      rowEl.className = "sm-hor-row";
      rowEl.dataset.dow = String(d);

      const dayCol = document.createElement("div");
      dayCol.className = "sm-hor-day-label";
      const dayLabel = document.createElement("label");
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "sm-hor-enabled";
      chk.dataset.dow = String(d);
      chk.checked = !!cfg.enabled;
      dayLabel.append(chk, document.createTextNode(smHorDayName(d)));
      dayCol.appendChild(dayLabel);

      const fieldsCol = document.createElement("div");
      fieldsCol.className = "sm-hor-fields";

      const r1 = document.createElement("div");
      r1.className = "sm-hor-range";
      const r1Label = document.createElement("span");
      r1Label.className = "sm-hor-range-label";
      r1Label.textContent = "Tramo 1:";
      const s1 = document.createElement("select");
      s1.className = "sm-hor-select sm-hor-start1";
      s1.dataset.dow = String(d);
      const e1 = document.createElement("select");
      e1.className = "sm-hor-select sm-hor-end1";
      e1.dataset.dow = String(d);

      SM_HOR_TIMES.forEach(v=>{
        const o1 = document.createElement("option");
        o1.value = v;
        o1.textContent = v || "—";
        if (v === cfg.start1) o1.selected = true;
        s1.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = v;
        o2.textContent = v || "—";
        if (v === cfg.end1) o2.selected = true;
        e1.appendChild(o2);
      });
      r1.append(r1Label, s1, document.createTextNode(" a "), e1);

      const r2 = document.createElement("div");
      r2.className = "sm-hor-range";
      const r2Label = document.createElement("span");
      r2Label.className = "sm-hor-range-label";
      r2Label.textContent = "Tramo 2 (opcional):";
      const s2 = document.createElement("select");
      s2.className = "sm-hor-select sm-hor-start2";
      s2.dataset.dow = String(d);
      const e2 = document.createElement("select");
      e2.className = "sm-hor-select sm-hor-end2";
      e2.dataset.dow = String(d);

      SM_HOR_TIMES.forEach(v=>{
        const o1 = document.createElement("option");
        o1.value = v;
        o1.textContent = v || "—";
        if (v === cfg.start2) o1.selected = true;
        s2.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = v;
        o2.textContent = v || "—";
        if (v === cfg.end2) o2.selected = true;
        e2.appendChild(o2);
      });
      r2.append(r2Label, s2, document.createTextNode(" a "), e2);

      fieldsCol.append(r1, r2);
      rowEl.append(dayCol, fieldsCol);
      grid.appendChild(rowEl);

      const updateDisabled = ()=>{
        const enabled = chk.checked;
        s1.disabled = e1.disabled = s2.disabled = e2.disabled = !enabled;
      };
      updateDisabled();
      chk.addEventListener("change", updateDisabled);
    }
  }

  function getConsultorById(cid){
    return (gConsultores || []).find(c => String(c.consultor_id || "").trim() === String(cid || "").trim());
  }

  function formatConsultorLabel(cid){
    if (!cid) return "";
    if (cid === "ALL") return "Todos";
    const c = getConsultorById(cid);
    const nombre = c && c.nombre ? " – "+c.nombre : "";
    return cid + nombre;
  }

  function syncDaysAheadInput(cid){
    const input = qs("#sm-hor-days-ahead");
    if (!input) return;
    const c = getConsultorById(cid);
    const val = (c && c.days_ahead_limit != null) ? c.days_ahead_limit : "";
    input.value = val === null ? "" : val;
  }

  async function loadScheduleForSelectedConsultor(){
    const sel = qs("#sm-hor-consultor");
    const grid = qs("#sm-hor-grid");
    if (!sel || !grid) return;

    const cid = sel.value;
    syncDaysAheadInput(cid);
    if (!cid){
      grid.innerHTML = "Selecciona un consultor.";
      return;
    }

    showLoader(true);
    try{
      const data = await apiGetSchedule(cid);
      if (!data.ok) throw new Error(data.error || "schedule_error");
      const schedule = data.days || data.schedule || [];
      renderScheduleEditor(schedule);
    }catch(err){
      console.error(err);
      grid.innerHTML = "Error al cargar horarios.";
      toast("Error al cargar horarios");
    }finally{
      showLoader(false);
    }
  }

  async function saveScheduleForSelectedConsultor(){
    const sel = qs("#sm-hor-consultor");
    const grid = qs("#sm-hor-grid");
    if (!sel || !grid) return;

    const cid = sel.value;
    if (!cid){
      toast("Selecciona un consultor");
      return;
    }

    const inputDays = qs("#sm-hor-days-ahead");
    let daysLimit = null;
    if (inputDays){
      const raw = (inputDays.value || "").trim();
      if (raw){
        const n = Number(raw);
        if (!Number.isFinite(n) || n < 1){
          toast("Días máximos debe ser un número mayor a 0");
          return;
        }
        daysLimit = Math.floor(n);
      }
    }

    const rows = [];
    for (let d=1; d<=7; d++){
      const enabledEl = grid.querySelector('.sm-hor-enabled[data-dow="'+d+'"]');
      const s1 = grid.querySelector('.sm-hor-start1[data-dow="'+d+'"]');
      const e1 = grid.querySelector('.sm-hor-end1[data-dow="'+d+'"]');
      const s2 = grid.querySelector('.sm-hor-start2[data-dow="'+d+'"]');
      const e2 = grid.querySelector('.sm-hor-end2[data-dow="'+d+'"]');
      if (!enabledEl || !s1 || !e1 || !s2 || !e2) continue;

      const enabled = enabledEl.checked;
      let start1 = s1.value || "";
      let end1   = e1.value || "";
      let start2 = s2.value || "";
      let end2   = e2.value || "";

      if (!enabled){
        start1 = end1 = start2 = end2 = "";
      }

      const mStart1 = start1 ? parseMinutes(start1) : null;
      const mEnd1   = end1   ? parseMinutes(end1)   : null;
      const mStart2 = start2 ? parseMinutes(start2) : null;
      const mEnd2   = end2   ? parseMinutes(end2)   : null;

      if (enabled){
        if (mStart1 == null || mEnd1 == null || mStart1 >= mEnd1){
          toast("Revisa el tramo 1 de "+smHorDayName(d));
          return;
        }
        if (start2 || end2){
          if (mStart2 == null || mEnd2 == null || mStart2 >= mEnd2){
            toast("Revisa el tramo 2 de "+smHorDayName(d));
            return;
          }
        }
      }

      rows.push({ dow: d, enabled, start1, end1, start2, end2 });
    }

    showLoader(true);
    try{
      const res = await apiSaveSchedule(cid, rows, daysLimit);
      if (!res.ok) throw new Error(res.error || "saveSchedule_error");
      const c = getConsultorById(cid);
      if (c){
        c.days_ahead_limit = daysLimit;
      }
      toast("Horarios guardados");
    }catch(err){
      console.error(err);
      toast("Error al guardar horarios");
    }finally{
      showLoader(false);
    }
  }

  // ===== REASIGNAR =====
  function showReassignModal(){
    const modal = qs("#sm-rea-modal");
    if (modal) modal.style.display = "flex";
  }
  function hideReassignModal(){
    const modal = qs("#sm-rea-modal");
    if (modal) modal.style.display = "none";
  }

  async function fetchReassignOptions(booking){
    if (!gConsultores || !gConsultores.length){
      const consData = await apiGetConsultores();
      if (!consData.ok) throw new Error(consData.error || "consultores_error");
      gConsultores = consData.consultores || [];
    }

    const targetTime = normTime(booking.hora);
    const result = [];
    for (const c of gConsultores){
      if (!c.activo) continue;
      const cid = String(c.consultor_id);
      if (cid === String(booking.consultor_id)) continue;

      try{
        const data = await apiSlots(cid, booking.fecha);
        if (!data.ok) continue;
        const slots = (data.slots || []).map(normTime);
        if (slots.includes(targetTime)){
          result.push({ consultor_id: cid, nombre: c.nombre || "" });
        }
      }catch(_){}
    }
    return result;
  }

  async function openReassignModal(booking){
    currentReassignBooking = booking;
    showReassignModal();

    const bodyEl = qs("#sm-rea-body");
    const rowSel = qs("#sm-rea-select-row");
    const sel    = qs("#sm-rea-select");
    const btnConf = qs("#sm-rea-confirm");

    if (bodyEl) bodyEl.textContent = "Buscando consultores disponibles para "+normTime(booking.hora)+"…";
    if (rowSel) rowSel.style.display = "none";
    if (sel) sel.innerHTML = "";
    if (btnConf) btnConf.disabled = true;

    try{
      const opts = await fetchReassignOptions(booking);
      if (!opts.length){
        if (bodyEl) bodyEl.textContent = "No hay ningún consultor con este horario disponible.";
        return;
      }

      if (bodyEl) bodyEl.textContent = "Selecciona el consultor al que quieres reasignar esta reunión:";
      if (rowSel) rowSel.style.display = "block";
      if (sel){
        sel.innerHTML = "";
        opts.forEach(o=>{
          const opt = document.createElement("option");
          opt.value = o.consultor_id;
          opt.textContent = o.consultor_id+" – "+(o.nombre || "Consultor");
          sel.appendChild(opt);
        });
      }
      if (btnConf) btnConf.disabled = false;
    }catch(err){
      console.error(err);
      if (bodyEl) bodyEl.textContent = "Ocurrió un error al buscar opciones de reasignación.";
    }
  }

  async function onConfirmReassign(){
    if (!currentReassignBooking) return;
    const sel = qs("#sm-rea-select");
    const newId = sel?.value || "";
    if (!newId){
      toast("Selecciona un consultor");
      return;
    }

    const b = currentReassignBooking;
    showLoader(true);
    try{
      const data = await apiBook({
        fecha: b.fecha,
        hora: normTime(b.hora),
        consultor: newId,
        nombre: b.nombre || "",
        email: b.email || "",
        telefono: b.telefono || "",
        marca: b.marca || "",
        tipo: b.tipo || "",
        idpipe: b.idpipe || ""
      });
      if (!data.ok){
        const msg = data.error === "slot_not_available"
          ? "Ese horario se ocupó justo ahora con ese consultor."
          : data.error === "too_soon"
          ? "La hora no cumple la regla de anticipación."
          : data.error === "too_far_consultor"
          ? "Esa fecha está fuera del rango permitido para ese consultor."
          : data.error === "no_consultor_for_date"
          ? "No hay consultores disponibles para esa fecha."
          : "No se pudo reasignar.";
        toast(msg);
        return;
      }

      await apiCancel(b.booking_id, "Reasignado a consultor "+newId);
      toast("Reunión reasignada");
      hideReassignModal();
      reloadBookings();
    }catch(err){
      console.error(err);
      toast("Error al reasignar");
    }finally{
      showLoader(false);
    }
  }

  // ===== REPROGRAMAR =====
  function showReprogModal(){
    const modal = qs("#sm-rp-modal");
    if (modal) modal.style.display = "flex";
  }
  function hideReprogModal(){
    const modal = qs("#sm-rp-modal");
    if (modal) modal.style.display = "none";
  }

  function rpBuildMonthKey(d){
    return d.getFullYear()+"-"+pad2(d.getMonth()+1);
  }

  async function rpEnsureAvailableDaysForCurrentMonth(){
    const mk = rpBuildMonthKey(rpState.currentMonth);
    if (rpState.availableDays[mk]) return;

    const y = rpState.currentMonth.getFullYear();
    const m = rpState.currentMonth.getMonth();
    const first = new Date(y, m, 1);
    const last  = new Date(y, m+1, 0);

    const from = first.getFullYear()+"-"+pad2(first.getMonth()+1)+"-"+pad2(first.getDate());
    const to   = last.getFullYear()+"-"+pad2(last.getMonth()+1)+"-"+pad2(last.getDate());

    const data = await apiAvailableDays(rpState.consultorId, from, to);
    if (!data.ok) throw new Error(data.error || "availableDays_error");
    rpState.availableDays[mk] = data.dates || [];
  }

  function rpRenderCalendar(){
    const wrap = qs("#sm-rp-cal");
    if (!wrap || !rpState.currentMonth) return;
    wrap.innerHTML = "";

    const d = rpState.currentMonth;
    const year  = d.getFullYear();
    const month = d.getMonth();

    const header = document.createElement("div");
    header.className = "sm-rp-cal-header";

    const monthLabel = document.createElement("div");
    monthLabel.className = "sm-rp-cal-month";
    const monthNames = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    monthLabel.textContent = monthNames[month]+" "+year;

    const nav = document.createElement("div");
    nav.className = "sm-rp-cal-nav";
    const btnPrev = document.createElement("button");
    btnPrev.type = "button";
    btnPrev.textContent = "‹";
    const btnNext = document.createElement("button");
    btnNext.type = "button";
    btnNext.textContent = "›";
    nav.append(btnPrev, btnNext);

    header.append(monthLabel, nav);
    wrap.appendChild(header);

    const grid = document.createElement("div");
    grid.className = "sm-rp-cal-grid";

    const dows = ["L","M","M","J","V","S","D"];
    dows.forEach(dn=>{
      const el = document.createElement("div");
      el.className = "sm-rp-dow";
      el.textContent = dn;
      grid.appendChild(el);
    });

    const firstDay = new Date(year, month, 1);
    let dow = firstDay.getDay();
    dow = (dow === 0 ? 7 : dow);
    const blanks = dow - 1;
    for (let i=0;i<blanks;i++){
      grid.appendChild(document.createElement("div"));
    }

    const daysInMonth = new Date(year, month+1, 0).getDate();
    const mk = rpBuildMonthKey(rpState.currentMonth);
    const availForMonth = new Set(rpState.availableDays[mk] || []);

    for (let day=1; day<=daysInMonth; day++){
      const dateObj = new Date(year, month, day);
      const ymd = dateObj.getFullYear()+"-"+pad2(dateObj.getMonth()+1)+"-"+pad2(dateObj.getDate());

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "sm-rp-day-btn";
      btn.textContent = String(day);

      const isAvailable = availForMonth.has(ymd);
      if (isAvailable) btn.classList.add("available");
      else btn.classList.add("disabled");

      if (rpState.selectedDate === ymd) btn.classList.add("selected");

      if (!isAvailable){
        btn.disabled = true;
      } else {
        btn.addEventListener("click", ()=>{
          rpState.selectedDate = ymd;
          rpState.selectedTime = null;
          qsa(".sm-rp-day-btn").forEach(b=> b.classList.toggle("selected", b === btn));
          rpLoadSlotsForSelectedDate();
        });
      }

      grid.appendChild(btn);
    }

    wrap.appendChild(grid);

    btnPrev.addEventListener("click", ()=>{
      const today = new Date(rpState.today);
      const minMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const prev = new Date(rpState.currentMonth.getFullYear(), rpState.currentMonth.getMonth()-1, 1);
      if (prev < minMonth) return;
      rpState.currentMonth = prev;
      rpEnsureAvailableDaysForCurrentMonth().then(rpRenderCalendar).catch(console.error);
    });

    btnNext.addEventListener("click", ()=>{
      const today = new Date(rpState.today);
      const maxDate = new Date(today.getTime());
      maxDate.setDate(maxDate.getDate() + Math.max(rpState.days_ahead_max - 1, 0));
      const maxMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
      const next = new Date(rpState.currentMonth.getFullYear(), rpState.currentMonth.getMonth()+1, 1);
      if (next > maxMonth) return;
      rpState.currentMonth = next;
      rpEnsureAvailableDaysForCurrentMonth().then(rpRenderCalendar).catch(console.error);
    });
  }

  async function rpLoadSlotsForSelectedDate(){
    const slotsWrap = qs("#sm-rp-slots");
    const label = qs("#sm-rp-date-label");
    const btnConfirm = qs("#sm-rp-confirm");
    if (!slotsWrap || !rpState.selectedDate) return;

    if (btnConfirm) btnConfirm.disabled = true;
    slotsWrap.textContent = "Cargando horarios…";

    try{
      const data = await apiSlots(rpState.consultorId, rpState.selectedDate);
      if (!data.ok) throw new Error(data.error || "slots_error");

      const slots = data.slots || [];
      if (label) label.textContent = "Horarios para "+rpState.selectedDate;

      if (!slots.length){
        slotsWrap.textContent = "No hay horarios disponibles en esta fecha.";
        return;
      }

      slotsWrap.innerHTML = "";
      slots.forEach(t=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sm-rp-slot-btn";
        btn.textContent = t;
        if (rpState.selectedTime === t) btn.classList.add("selected");
        btn.addEventListener("click", ()=>{
          rpState.selectedTime = t;
          qsa(".sm-rp-slot-btn").forEach(b=> b.classList.toggle("selected", b === btn));
          if (btnConfirm) btnConfirm.disabled = !rpState.selectedTime;
        });
        slotsWrap.appendChild(btn);
      });
    }catch(err){
      console.error(err);
      slotsWrap.textContent = "Error al cargar horarios.";
    }
  }

  async function openReprogModal(booking){
    currentReprogBooking = booking;
    showReprogModal();

    const body = qs("#sm-rp-body");
    const slotsWrap = qs("#sm-rp-slots");
    const label = qs("#sm-rp-date-label");
    const cal = qs("#sm-rp-cal");
    const btnConfirm = qs("#sm-rp-confirm");

    if (body) body.textContent = "Selecciona una nueva fecha y horario para el consultor "+String(booking.consultor_id)+".";
    if (slotsWrap) slotsWrap.innerHTML = "";
    if (label) label.textContent = "Selecciona una fecha";
    if (cal) cal.textContent = "Cargando calendario…";
    if (btnConfirm) btnConfirm.disabled = true;

    rpState.consultorId = String(booking.consultor_id);
    rpState.availableDays= {};
    rpState.selectedDate = null;
    rpState.selectedTime = null;

    try{
      if (!rpState.inited){
        const init = await apiInitBooking();
        if (!init.ok) throw new Error(init.error || "init_booking_error");
        rpState.today = init.today;
        rpState.global_days_ahead_max = init.days_ahead_max || 90;
        rpState.days_ahead_max = init.days_ahead_max || 90;
        rpState.inited = true;
      }

      rpState.days_ahead_max = consultorCapDays(rpState.consultorId);

      const todayDate = new Date(rpState.today);
      rpState.currentMonth = new Date(todayDate.getFullYear(), todayDate.getMonth(), 1);
      await rpEnsureAvailableDaysForCurrentMonth();
      rpRenderCalendar();
    }catch(err){
      console.error(err);
      if (cal) cal.textContent = "Error al cargar calendario.";
    }
  }

  async function onConfirmReprog(){
    if (!currentReprogBooking) return;
    if (!rpState.selectedDate || !rpState.selectedTime){
      toast("Selecciona fecha y hora");
      return;
    }

    const b = currentReprogBooking;
    showLoader(true);
    try{
      const data = await apiBook({
        fecha: rpState.selectedDate,
        hora: rpState.selectedTime,
        consultor: rpState.consultorId,
        nombre: b.nombre || "",
        email: b.email || "",
        telefono: b.telefono || "",
        marca: b.marca || "",
        tipo: b.tipo || "",
        idpipe: b.idpipe || ""
      });
      if (!data.ok){
        const msg = data.error === "slot_not_available"
          ? "Ese horario se ocupó justo ahora."
          : data.error === "too_soon"
          ? "La hora no cumple la regla de anticipación."
          : data.error === "too_far_consultor"
          ? "Esa fecha está fuera del rango permitido para el consultor."
          : data.error === "no_consultor_for_date"
          ? "No hay consultores disponibles para esa fecha."
          : "No se pudo reprogramar.";
        toast(msg);
        return;
      }

      const motivo = "Reprogramado a "+rpState.selectedDate+" "+rpState.selectedTime;
      await apiCancel(b.booking_id, motivo);
      toast("Reunión reprogramada");
      hideReprogModal();
      reloadBookings();
    }catch(err){
      console.error(err);
      toast("Error al reprogramar");
    }finally{
      showLoader(false);
    }
  }

  // ===== Presencia en reuniones en curso =====
  async function checkPresenceForBooking(booking, el, windowMs){
    if (!el || !windowMs){
      if (el) applyPresenceClass(el, "missing");
      return false;
    }

    const idpipe = String(booking.idpipe || "").trim();
    if (!idpipe){
      applyPresenceClass(el, "missing");
      return false;
    }

    try{
      const data = await apiPresenceStatus(idpipe);
      if (!data.ok) throw new Error(data.error || "presence_error");

      const now = Date.now();
      const monitorStart = windowMs.monitorStartMs ?? windowMs.startMs;
      const monitorEnd   = windowMs.monitorEndMs ?? windowMs.endMs;

      if (now < monitorStart){
        applyPresenceClass(el, "pending");
        return false;
      }

      const lastInMs = parsePresenceTs(data.lastIn);
      const active = data.activo === true || String(data.activo || "").toLowerCase() === "true";
      const validStart = windowMs.startMs - (PRESENCE_LOOKBACK_MINUTES * 60 * 1000);
      const validEnd = windowMs.endMs;
      const nowWithinSlot = now >= monitorStart && now <= monitorEnd;
      const hasIn = lastInMs && lastInMs >= validStart && lastInMs <= validEnd;
      const shouldBeGreen = nowWithinSlot && (hasIn || active);

      applyPresenceClass(el, shouldBeGreen ? "present" : "missing");

      return shouldBeGreen;
    }catch(err){
      console.error(err);
      applyPresenceClass(el, "missing");
      return false;
    }
  }

  function stopPresenceWatcher(key){
    const w = presenceWatchers.get(key);
    if (w && w.timer) clearInterval(w.timer);
    presenceWatchers.delete(key);
  }

  function startPresenceWatcher(booking, el, windowMs){
    const key = presenceKey(booking);
    if (!key || !el) return;

    // Si ya fue marcado verde previamente, no re-consultamos
    if (presenceGreens.has(key)){
      applyPresenceClass(el, "present");
      return;
    }

    stopPresenceWatcher(key);
    applyPresenceClass(el, "pending");

    if (!windowMs) return;
    const gen = presenceGeneration;

    const stopAt = windowMs.monitorEndMs ?? windowMs.endMs;

    const tick = async ()=>{
      if (gen !== presenceGeneration){
        stopPresenceWatcher(key);
        return true;
      }
      if (!document.body.contains(el)){
        stopPresenceWatcher(key);
        return true;
      }
      const now = Date.now();
      if (now >= stopAt){
        stopPresenceWatcher(key);
        return true;
      }
      const green = await checkPresenceForBooking(booking, el, windowMs);
      if (green) presenceGreens.add(key);
      if (green || now >= stopAt){
        stopPresenceWatcher(key);
        return true;
      }
      return false;
    };

    (async ()=>{
      const done = await tick();
      if (done || gen !== presenceGeneration) return;
      const timer = setInterval(async ()=>{
        const finished = await tick();
        if (finished){
          clearInterval(timer);
          presenceWatchers.delete(key);
        }
      }, PRESENCE_RETRY_MS);
      presenceWatchers.set(key, { timer });
    })();
  }

    // ===== RENDER LISTADO (AHORA IGUAL AL LAYOUT DE CONSULTORES) =====
  function renderBookings(dateStr, bookings){
    const wrap = qs("#sm-admin-list");
    const countEl = qs("#sm-admin-count");
    const totalActives = Array.isArray(bookings)
      ? bookings.filter(b => !b.cancelado).length
      : 0;
    if (countEl) countEl.textContent = `${totalActives} reuniones totales.`;
    if (!wrap) return;
    clearPresenceWatchers();
    wrap.innerHTML = "";

    if (!bookings || !bookings.length){
      wrap.textContent = "No hay agendamientos para esta fecha.";
      return;
    }

    const now = new Date();
    const todayStr = ymdToday();
    const nowMin = now.getHours()*60 + now.getMinutes();

    bookings.forEach(b=>{
      const item = document.createElement("div");
      item.className = "sm-admin-item";

      const windowMs = bookingWindowMs(b);
      let isPast=false, isNow=false;
      if (b.fecha === todayStr){
        const startM = parseMinutes(b.hora);
        const winStart = startM != null ? startM - PRESENCE_WINDOW_ADVANCE_MIN : null;
        const endM = startM!=null ? startM + (PRESENCE_SLOT_DURATION_MIN - PRESENCE_WINDOW_ADVANCE_MIN) : null;
        if (startM != null){
          if (endM <= nowMin) isPast = true;
          else if (winStart != null && winStart <= nowMin && nowMin < endM) isNow = true;
        }
      } else if (b.fecha < todayStr){
        isPast = true;
      }

      if (isPast) item.classList.add("is-past");
      if (isNow) item.classList.add("is-now");
      if (b.cancelado) item.classList.add("is-cancelled");

      const main = document.createElement("div");
      main.className = "sm-admin-item-main";

      // Fila superior: Hora + Consultor (al lado)
      const topRow = document.createElement("div");
      topRow.className = "smad-info-row";

      const bHora = document.createElement("span");
      bHora.className = "sm-admin-badge sm-admin-badge-hora";
      bHora.textContent = b.hora;

      const bCons = document.createElement("span");
      bCons.className = "sm-admin-badge sm-admin-badge-consultor";
      bCons.textContent = String(b.consultor_id || "").trim();

      topRow.append(bHora, bCons);
      main.appendChild(topRow);

      // ID Pipe copiable (5 + "...")
      const idValue = b.idpipe || "";
      const idDisplay = idValue ? (idValue.length > 5 ? idValue.slice(0,5) + "..." : idValue) : "";
      const idRow = makeCopyRow(idValue, idDisplay);
      if (idRow) main.appendChild(idRow);

      // Teléfono copiable
      const telRow = makeCopyRow(b.telefono || "");
      if (telRow) main.appendChild(telRow);

      // Nombre (solo dato)
      const nombreRow = document.createElement("div");
      nombreRow.className = "smad-info-row";
      const nombreValue = document.createElement("span");
      nombreValue.className = "smad-info-value";
      nombreValue.textContent = (b.nombre || "(sin nombre)");
      nombreRow.appendChild(nombreValue);
      main.appendChild(nombreRow);

      // Tipo al final (badge), solo si existe
      if (b.tipo){
        const tipoRow = document.createElement("div");
        tipoRow.className = "smad-info-row";
        const tipoSpan = document.createElement("span");
        tipoSpan.className = "smad-badge-tipo";
        tipoSpan.textContent = b.tipo;
        tipoRow.appendChild(tipoSpan);
        main.appendChild(tipoRow);
      }

      // Retraso enviado (solo si existe)
      (function(){
        const retrasoOk = !!(b.retraso_enviado && String(b.retraso_enviado).trim());
        if (!retrasoOk) return;
        const row = document.createElement("div");
        row.className = "smad-info-row";
        const badge = document.createElement("span");
        badge.className = "sm-admin-badge sm-admin-badge-delay";
        badge.textContent = "Retraso enviado";
        row.appendChild(badge);
        main.appendChild(row);
      })();

      // No-show badge (asistencia=no_show)
      (function(){
        const noShow = String(b.asistencia || "").toLowerCase() === "no_show";
        if (!noShow) return;
        const row = document.createElement("div");
        row.className = "smad-info-row";
        const badge = document.createElement("span");
        badge.className = "sm-admin-badge sm-admin-badge-noshow";
        badge.textContent = "No se llamó";
        row.appendChild(badge);
        main.appendChild(row);
      })();

      // Cancelado badge (si aplica)
      if (b.cancelado){
        const bc = document.createElement("span");
        bc.className = "sm-admin-badge sm-admin-badge-cancel";
        bc.textContent = "Cancelado";
        main.appendChild(bc);

        // Motivo de cancelación con truncado + tooltip nativo
        const fullMotivo = String(b.motivo_cancelacion || "").trim();
        if (fullMotivo){
          const motivoRow = document.createElement("div");
          motivoRow.className = "smad-info-row smad-info-row-motivo";

          const motivoSpan = document.createElement("span");
          motivoSpan.className = "smad-info-value smad-info-value-motivo";
          motivoSpan.textContent = "Motivo: " + fullMotivo;
          // Tooltip nativo con el texto completo
          motivoSpan.title = fullMotivo;

          motivoRow.appendChild(motivoSpan);
          main.appendChild(motivoRow);
        }
      }

      const actions = document.createElement("div");
      actions.className = "sm-admin-actions";

      if (!b.cancelado && !isPast){
        const reasignBtn = document.createElement("button");
        reasignBtn.type = "button";
        reasignBtn.className = "sm-admin-btn sm-admin-btn-yellow sm-admin-btn-icon";
        reasignBtn.title = "Reasignar";
        reasignBtn.setAttribute("aria-label","Reasignar");
        reasignBtn.setAttribute("data-tooltip","Reasignar");
        reasignBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right-left-icon lucide-arrow-right-left"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>';
        reasignBtn.addEventListener("click", ()=> openReassignModal(b));
        actions.appendChild(reasignBtn);
      }

      if (!b.cancelado){
        const rpBtn = document.createElement("button");
        rpBtn.type = "button";
        rpBtn.className = "sm-admin-btn sm-admin-btn-orange sm-admin-btn-icon";
        rpBtn.title = "Reprogramar";
        rpBtn.setAttribute("aria-label","Reprogramar");
        rpBtn.setAttribute("data-tooltip","Reprogramar");
        rpBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-sync-icon lucide-calendar-sync"><path d="M11 10v4h4"/><path d="m11 14 1.535-1.605a5 5 0 0 1 8 1.5"/><path d="M16 2v4"/><path d="m21 18-1.535 1.605a5 5 0 0 1-8-1.5"/><path d="M21 22v-4h-4"/><path d="M21 8.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h4.3"/><path d="M3 10h4"/><path d="M8 2v4"/></svg>';
        rpBtn.addEventListener("click", ()=> openReprogModal(b));
        actions.appendChild(rpBtn);
      }

      if (!b.cancelado){
        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "sm-admin-btn sm-admin-btn-red sm-admin-btn-icon";
        cancelBtn.title = "Cancelar";
        cancelBtn.setAttribute("aria-label","Cancelar");
        cancelBtn.setAttribute("data-tooltip","Cancelar");
        cancelBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban-icon lucide-ban"><path d="M4.929 4.929 19.07 19.071"/><circle cx="12" cy="12" r="10"/></svg>';
        cancelBtn.addEventListener("click", async ()=>{
          const motivo = prompt("Motivo de cancelación:");
          if (motivo === null) return;
          showLoader(true);
          try{
            const res = await apiCancel(b.booking_id, motivo || "");
            if (!res.ok) throw new Error(res.error || "cancel_error");
            toast("Reserva cancelada");
            reloadBookings();
          }catch(err){
            console.error(err);
            toast("Error al cancelar");
          }finally{
            showLoader(false);
          }
        });
        actions.appendChild(cancelBtn);
      }

      item.append(main, actions);
      wrap.appendChild(item);

      if (!b.cancelado && isNow){
        startPresenceWatcher(b, item, windowMs);
      }
    });

    attachActionTooltips();
  }


  // Tooltips flotantes para acciones (similar a consultor)
  let flyTooltip = null;
  function removeFlyTooltip(){
    if (flyTooltip){
      flyTooltip.remove();
      flyTooltip = null;
    }
  }
  function showFlyTooltip(el){
    const txt = (el.getAttribute("data-tooltip") || "").trim();
    if(!txt) return;
    removeFlyTooltip();
    const tip = document.createElement("div");
    tip.className = "smc-fly-tooltip";
    tip.textContent = txt;
    document.body.appendChild(tip);
    const rect = el.getBoundingClientRect();
    const tw = tip.offsetWidth;
    const th = tip.offsetHeight;
    const top = rect.top - th - 8;
    const left = rect.left + (rect.width/2) - (tw/2);
    tip.style.top = Math.max(4, top) + "px";
    tip.style.left = Math.max(4, left) + "px";
    flyTooltip = tip;
  }
  function attachActionTooltips(){
    const els = qsa(".sm-admin-btn-icon[data-tooltip]");
    els.forEach(el=>{
      if(el._smTipBound) return;
      el._smTipBound = true;
      el.addEventListener("mouseenter", ()=> showFlyTooltip(el));
      el.addEventListener("mouseleave", removeFlyTooltip);
    });
    if (!attachActionTooltips._scrollBound){
      window.addEventListener("scroll", removeFlyTooltip, true);
      attachActionTooltips._scrollBound = true;
    }
  }



  async function reloadBookings(){
    const dateInput = qs("#sm-admin-date");
    const sel = qs("#sm-admin-consultor");
    if (!dateInput || !sel) return;

    const dateStr = dateInput.value || ymdToday();
    const consultor = sel.value || "todos";

    showLoader(true);
    try{
      const data = await apiListBookings(dateStr, consultor);
      if (!data.ok) throw new Error(data.error || "list_error");
      renderBookings(dateStr, data.bookings || []);
      lastBookingReloadMs = Date.now();
    }catch(err){
      console.error(err);
      toast("Error al cargar agendamientos");
    }finally{
      showLoader(false);
    }
  }

  // ===== Selects de consultores =====
  function buildConsultorSelects(consultores){
    const selList  = qs("#sm-admin-consultor");
    const selBlock = qs("#sm-block-consultor");
    const selHor   = qs("#sm-hor-consultor");

    if (selList){
      selList.innerHTML = "";
      const oAll = document.createElement("option");
      oAll.value = "todos";
      oAll.textContent = "Todos";
      selList.appendChild(oAll);

      consultores.filter(c => c.activo).forEach(c=>{
        const o = document.createElement("option");
        o.value = c.consultor_id;
        o.textContent = c.consultor_id+" – "+(c.nombre || "Consultor");
        selList.appendChild(o);
      });

      selList.value = "todos";
    }

    if (selBlock){
      selBlock.innerHTML = "";
      const oAll = document.createElement("option");
      oAll.value = "ALL";
      oAll.textContent = "Todos";
      selBlock.appendChild(oAll);

      consultores.filter(c => c.activo).forEach(c=>{
        const o = document.createElement("option");
        o.value = c.consultor_id;
        o.textContent = c.consultor_id+" – "+(c.nombre || "Consultor");
        selBlock.appendChild(o);
      });

      selBlock.value = "ALL";
    }

    if (selHor){
      selHor.innerHTML = "";
      const prevValue = selHor.value || "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Selecciona un consultor";
      selHor.appendChild(placeholder);

      const activos = consultores.filter(c=>c.activo);

      if (activos.length){
        activos.forEach(c=>{
          const o = document.createElement("option");
          o.value = c.consultor_id;
          o.textContent = c.consultor_id+" – "+(c.nombre || "Consultor");
          selHor.appendChild(o);
        });
        if (prevValue && activos.some(c=>c.consultor_id === prevValue)){
          selHor.value = prevValue;
        } else {
          selHor.value = "";
        }
        loadScheduleForSelectedConsultor();
      } else {
        placeholder.textContent = "Sin consultores activos";
        selHor.value = "";
        loadScheduleForSelectedConsultor();
      }
    }
  }

  function renderConsultorList(consultores){
    const wrap = qs("#sm-consultor-list");
    if (!wrap) return;
    wrap.innerHTML = "";

    const activos = (consultores || []).filter(c => c.activo);
    if (!activos.length){
      wrap.textContent = "No hay consultores activos.";
      return;
    }

    activos.forEach(c=>{
      const row = document.createElement("div");
      row.className = "sm-cons-row";

      const info = document.createElement("div");
      info.className = "sm-cons-info";

      const idSpan = document.createElement("span");
      idSpan.className = "sm-cons-id";
      idSpan.textContent = c.consultor_id;

      const nameSpan = document.createElement("span");
      nameSpan.textContent = " – " + (c.nombre || "Consultor");

      info.append(idSpan, nameSpan);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "sm-cons-delete-btn";
      btn.textContent = "Eliminar";
      btn.addEventListener("click", async ()=>{
        if (!confirm("¿Eliminar consultor "+c.consultor_id+"? Ya no aparecerá en los listados.")) return;
        showLoader(true);
        try{
          const res = await apiDeleteConsultor(c.consultor_id);
          if (!res.ok){
            const msg = res.error === "not_found" ? "Consultor no encontrado" : "Error al eliminar consultor";
            toast(msg);
            return;
          }
          toast("Consultor eliminado");
          const consData = await apiGetConsultores();
          if (consData.ok){
            gConsultores = consData.consultores || [];
            buildConsultorSelects(gConsultores);
            renderConsultorList(gConsultores);
          }
        }catch(err){
          console.error(err);
          toast("Error al eliminar consultor");
        }finally{
          showLoader(false);
        }
      });

      row.append(info, btn);
      wrap.appendChild(row);
    });
  }

  function renderBlockList(blocks){
    const wrap = qs("#sm-block-list");
    if (!wrap) return;
    wrap.innerHTML = "";

    const today = ymdToday();
    const upcoming = (blocks || []).filter(b=> String(b.fecha || "") >= today);

    if (!upcoming.length){
      wrap.textContent = "No hay fechas bloqueadas.";
      return;
    }

    const sorted = [...upcoming].sort((a,b)=>{
      if (a.fecha === b.fecha){
        return String(a.consultor_id || "").localeCompare(String(b.consultor_id || ""));
      }
      return String(a.fecha || "").localeCompare(String(b.fecha || ""));
    });

    sorted.forEach(b=>{
      const row = document.createElement("div");
      row.className = "sm-block-row";

      const info = document.createElement("div");
      info.className = "sm-block-info";

      const fechaEl = document.createElement("div");
      fechaEl.className = "sm-block-date";
      fechaEl.textContent = formatDateDDMMYYYY(b.fecha);

      const consEl = document.createElement("div");
      consEl.className = "sm-block-consultor";
      consEl.textContent = "Consultor: " + formatConsultorLabel(b.consultor_id || "ALL");

      info.append(fechaEl, consEl);

      const motivo = String(b.motivo || "").trim();
      if (motivo){
        const motEl = document.createElement("div");
        motEl.className = "sm-block-motivo";
        motEl.textContent = "Motivo: " + motivo;
        info.appendChild(motEl);
      }

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "sm-block-delete-btn";
      btn.textContent = "Eliminar";
      btn.addEventListener("click", async ()=>{
        const cid = b.consultor_id || "ALL";
        const confirmMsg = "¿Quitar bloqueo del "+formatDateDDMMYYYY(b.fecha)+" para "+formatConsultorLabel(cid)+"?";
        if (!confirm(confirmMsg)) return;

        showLoader(true);
        try{
          const res = await apiUnblockDate(b.fecha, cid);
          if (!res.ok) throw new Error(res.error || "unblock_error");
          toast("Bloqueo eliminado");
          await loadBlockList(false);
          reloadBookings();
        }catch(err){
          console.error(err);
          toast("Error al eliminar bloqueo");
        }finally{
          showLoader(false);
        }
      });

      row.append(info, btn);
      wrap.appendChild(row);
    });
  }

  async function loadBlockList(withLoader = true){
    const sel = qs("#sm-block-consultor");
    const cid = sel?.value || "ALL";

    if (withLoader) showLoader(true);
    try{
      const data = await apiListBlocks(cid);
      if (!data.ok) throw new Error(data.error || "blocks_error");
      renderBlockList(data.blocks || []);
    }catch(err){
      console.error(err);
      toast("Error al cargar bloqueos");
    }finally{
      if (withLoader) showLoader(false);
    }
  }

  async function initAdmin(){
    showLoader(true);
    try{
      const dateInput = qs("#sm-admin-date");
      if (dateInput) dateInput.value = ymdToday();

      const consData = await apiGetConsultores();
      if (!consData.ok) throw new Error(consData.error || "consultores_error");
      gConsultores = consData.consultores || [];

      buildConsultorSelects(gConsultores);
      renderConsultorList(gConsultores);
      await loadBlockList(false);
      await reloadBookings();
    }catch(err){
      console.error(err);
      toast("Error al cargar admin");
    }finally{
      showLoader(false);
    }
  }

  // ===== Eventos globales =====
  document.addEventListener("DOMContentLoaded", ()=>{
    if (!window.__smAuth) return;

    const dateInput = qs("#sm-admin-date");
    const selCons   = qs("#sm-admin-consultor");
    const selBlock  = qs("#sm-block-consultor");
    if (dateInput) dateInput.addEventListener("change", reloadBookings);
    if (selCons)   selCons.addEventListener("change", reloadBookings);
    if (selBlock)  selBlock.addEventListener("change", ()=> loadBlockList());

    const btnBlock = qs("#sm-btn-block");
    const btnUnblock = qs("#sm-btn-unblock");

    if (btnBlock){
      btnBlock.addEventListener("click", async ()=>{
        const fecha = qs("#sm-block-date")?.value || "";
        const consultor_id = qs("#sm-block-consultor")?.value || "ALL";
        const motivo = qs("#sm-block-motivo")?.value || "";
        if (!fecha){ toast("Selecciona fecha"); return; }

        showLoader(true);
        try{
          const res = await apiBlockDate(fecha, consultor_id, motivo);
          if (!res.ok) throw new Error(res.error || "block_error");
          toast("Fecha bloqueada");
          await loadBlockList(false);
          reloadBookings();
        }catch(err){
          console.error(err);
          toast("Error al bloquear");
        }finally{
          showLoader(false);
        }
      });
    }

    if (btnUnblock){
      btnUnblock.addEventListener("click", async ()=>{
        const fecha = qs("#sm-block-date")?.value || "";
        const consultor_id = qs("#sm-block-consultor")?.value || "ALL";
        if (!fecha){ toast("Selecciona fecha"); return; }

        showLoader(true);
        try{
          const res = await apiUnblockDate(fecha, consultor_id);
          if (!res.ok) throw new Error(res.error || "unblock_error");
          toast("Fecha desbloqueada");
          await loadBlockList(false);
          reloadBookings();
        }catch(err){
          console.error(err);
          toast("Error al desbloquear");
        }finally{
          showLoader(false);
        }
      });
    }

    const btnAddCons = qs("#sm-btn-add-consultor");
    if (btnAddCons){
      btnAddCons.addEventListener("click", async ()=>{
        const id = (qs("#sm-new-consultor-id")?.value || "").trim();
        const nombre = (qs("#sm-new-consultor-name")?.value || "").trim();
        if (!id){ toast("Ingresa un ID"); return; }

        showLoader(true);
        try{
          const res = await apiAddConsultor(id, nombre);
          if (!res.ok){
            const msg = res.error === "duplicate_consultor_id" ? "Ese ID ya existe" : "Error al agregar consultor";
            toast(msg);
          } else {
            toast("Consultor agregado");
            const consData = await apiGetConsultores();
            if (consData.ok){
              gConsultores = consData.consultores || [];
              buildConsultorSelects(gConsultores);
              renderConsultorList(gConsultores);
            }
          }
        }catch(err){
          console.error(err);
          toast("Error al agregar consultor");
        }finally{
          showLoader(false);
        }
      });
    }

    initAdmin();

    // Editor de horarios
    const selHor    = qs("#sm-hor-consultor");
    const btnHorSave = qs("#sm-hor-save");
    if (selHor) selHor.addEventListener("change", loadScheduleForSelectedConsultor);
    if (btnHorSave) btnHorSave.addEventListener("click", saveScheduleForSelectedConsultor);

    // Modales
    const reaModal = qs("#sm-rea-modal");
    if (reaModal){
      reaModal.querySelector(".sm-rea-backdrop")?.addEventListener("click", hideReassignModal);
      reaModal.querySelector("#sm-rea-cancel")?.addEventListener("click", hideReassignModal);
      reaModal.querySelector("#sm-rea-confirm")?.addEventListener("click", onConfirmReassign);
    }

    const rpModal = qs("#sm-rp-modal");
    if (rpModal){
      rpModal.querySelector(".sm-rp-backdrop")?.addEventListener("click", hideReprogModal);
      rpModal.querySelector("#sm-rp-cancel")?.addEventListener("click", hideReprogModal);
      rpModal.querySelector("#sm-rp-confirm")?.addEventListener("click", onConfirmReprog);
    }

    const refreshBtn = qs("#sm-admin-refresh-btn");
    if (refreshBtn){
      refreshBtn.addEventListener("click", ()=> reloadBookings());
    }

    // Auto-refresh alineado a cuartos (00,15,30,45) y robusto frente a background
    (function setupQuarterRefresh(){
      let cancelTicker = null;
      let pendingAlign = null;

      const tickOnce = ()=>{
        const panel = qs("#sm-admin-panel");
        if (panel && panel.style.display !== "none"){
          reloadBookings();
        }
      };

      const clearTicker = ()=>{
        if (cancelTicker) cancelTicker();
        cancelTicker = null;
        if (pendingAlign) clearTimeout(pendingAlign);
        pendingAlign = null;
      };

      const delayToNextAligned = ()=>{
        const now = Date.now();
        const next = Math.ceil((now + REFRESH_OFFSET_MS) / REFRESH_ALIGN_MS) * REFRESH_ALIGN_MS - REFRESH_OFFSET_MS;
        return Math.max(500, next - now);
      };

      const startTicker = ()=>{
        clearTicker();
        pendingAlign = setTimeout(()=>{
          pendingAlign = null;
          cancelTicker = runEveryAligned(REFRESH_ALIGN_MS, tickOnce, REFRESH_OFFSET_MS);
        }, delayToNextAligned());
      };

      const shouldReloadOnResume = ()=>{
        const nowQ = Math.floor((Date.now() + REFRESH_OFFSET_MS) / REFRESH_ALIGN_MS);
        const lastQ = Math.floor((lastBookingReloadMs + REFRESH_OFFSET_MS) / REFRESH_ALIGN_MS);
        return nowQ > lastQ;
      };

      startTicker();
      onResume(()=>{
        if (shouldReloadOnResume()){
          tickOnce();
        }
        startTicker(); // re-alinea el ticker a los minutos 00/15/30/45
      });
    })();
  });
})();
</script>

<script>
(function(){
  function setLoadingButton(btn, loadingText){
    if (!btn || btn.dataset.loading === "1") return;

    btn.dataset.loading = "1";
    btn.dataset.label = btn.textContent.trim();
    btn.textContent = loadingText;
    btn.disabled = true;

    const loader = document.getElementById("sm-admin-loader");

    const timer = setInterval(function(){
      if (!loader || loader.style.display === "none"){
        clearInterval(timer);
        btn.textContent = btn.dataset.label || "";
        btn.disabled = false;
        btn.dataset.loading = "0";
      }
    }, 200);

    setTimeout(function(){
      if (btn.dataset.loading === "1"){
        clearInterval(timer);
        btn.textContent = btn.dataset.label || "";
        btn.disabled = false;
        btn.dataset.loading = "0";
      }
    }, 15000);
  }

  document.addEventListener("DOMContentLoaded", function(){
    const btnReassign = document.getElementById("sm-rea-confirm");
    const btnReprog   = document.getElementById("sm-rp-confirm");

    if (btnReassign){
      btnReassign.addEventListener("click", function(){
        if (btnReassign.disabled) return;
        setLoadingButton(btnReassign, "Reasignando...");
      });
    }

    if (btnReprog){
      btnReprog.addEventListener("click", function(){
        if (btnReprog.disabled) return;
        setLoadingButton(btnReprog, "Reprogramando...");
      });
    }
  });
})();
</script>

</body>
</html>
